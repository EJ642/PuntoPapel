<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Punto Papel - Pago a Proveedores</title>
  <!-- Icono -->
  <link rel="icon" href="img/logo16px.png" type="image/png">
  <!-- CSS -->
  <link rel="stylesheet" href="css/estilos.css">
  <!-- Bootstrap -->
  <link rel="stylesheet" href="bt/bootstrap.min.css">
  <script src="bt/bootstrap.bundle.min.js"></script>
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
  <!-- DataTables -->
  <link rel="stylesheet" href="dt/datatables.min.css">
  <!-- AlertifyJS -->
  <link rel="stylesheet" href="alert/alertify.min.css">
  <link rel="stylesheet" href="alert/themes/default.min.css">
  <!-- CSS Personalizado -->
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <!-- Navbar -->
  <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li id="opcArticulos"><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li id="opcProveedores"><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li id="opcMarcas"><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li id="opcCategorias"><a class="dropdown-item" href="categorias.html">Categorías</a></li>
                                <li id="opcClientes"><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                                <li id="opcUsuario"><a class="dropdown-item" href="usuario.html">Usuarios</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="compra.html">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="compras_hechas.html">Listado de compras</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li id="opcPagos"><a class="dropdown-item" href="pago_proveedores.html">Pago a Proveedores</a></li>
                                <li id="opcListado"><a class="dropdown-item" href="pagos_hechos.html">Listado de pagos</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuStock">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Stock
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ajuste_stock.html">Ajuste de Stock</a></li>
                                <li><a class="dropdown-item" href="ajustes_hechos.html">Listado de ajustes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="Registrodeventas.html">Registro de ventas</a></li>
                                <li id="opcListadoVentas"><a class="dropdown-item" href="ventas_realizadas.html">Listado de ventas</a></li>
                                <li id="opcCredito"><a class="dropdown-item" href="creditos_clientes.html">Créditos con clientes</a></li>
                                <li id="opcCobro"><a class="dropdown-item" href="historial_de pagos.html">Cobro de créditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="informe_venta.html">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="informe_credito.html">Informes de créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="informe_cobro_credito.html">Informes de cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="informeCompra.html">Informes de compras</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!" onclick="abrirPerfil()">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
  <!-- Contenido Principal -->
  <div class="container mt-4 cont-principal">
    <h2 class="mb-4"><i class="bi bi-cash-coin"></i> Pago a Proveedores</h2>
    <!-- Formulario de Pago -->
    <div class="card shadow mb-4">
      <div class="card-body">
        <form id="formPagoProveedor">
          <div class="row g-3">
            <!-- Proveedor con búsqueda por RUC -->
            <div class="col-md-6">
              <label class="form-label">Proveedor (RUC)</label>
              <div class="input-group">
                <input type="text" class="form-control" id="rucProveedor" 
                       placeholder="Buscar por RUC (F2)" 
                       pattern="[0-9\-]+"
                       maxlength="15"
                       required
                       readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="mostrarModalProveedores()">
                  <i class="bi bi-search"></i> Buscar
                </button>
              </div>
              <input type="hidden" id="idproveedor">
              <div class="form-text" id="nombreProveedor">No seleccionado</div>
            </div>
            <!-- Importe Total -->
            <div class="col-md-4">
              <label class="form-label">Importe Total</label>
              <div class="input-group">
                <span class="input-group-text">₲</span>
                <input type="number" class="form-control text-right" id="importeTotal" placeholder="0" min="0" readonly>
              </div>
            </div>
            <!-- Fecha de Pago -->
            <div class="col-md-4">
              <label class="form-label">Fecha de Pago</label>
              <input type="text" class="form-control" id="fechaPago" required readonly>
            </div>
            <!-- Botones -->
            <div class="col-12 text-end">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Registrar Pago
              </button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Tabla de Facturas Pendientes -->
    <div class="card shadow">
      <div class="card-header">
        <h5 class="mb-0">Facturas Pendientes del Proveedor</h5>
      </div>
      <div class="card-body">
        <table id="tablaFacturas" class="table table-striped" style="width:100%">
          <thead>
            <tr>
              <th>Seleccionar</th>
              <th>N° Factura</th>
              <th>Fecha</th>
              <th>Condición</th>
              <th class="text-right">Total</th>
              <th>Estado</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal para buscar proveedor -->
  <div class="modal fade" id="modalBuscarProveedor" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Seleccionar Proveedor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <table id="tablaProveedoresModal" class="table table-striped" style="width:100%">
            <thead>
              <tr>
                <th>RUC</th>
                <th>Nombre</th>
                <th>Seleccionar</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="dt/jquery-3.7.1.js"></script>
  <script src="dt/datatables.min.js"></script>
  <script src="dt/es-ES.js"></script>
  <script src="alert/alertify.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      // Verificar sesión
      const nombre = sessionStorage.getItem("nomUsuario");
      if (!nombre) {
        window.location.href = "error.html";
        return;
      }
      document.getElementById("usuario").textContent = nombre;

      // Configurar fecha actual en formato dd/mm/aaaa
      const hoy = new Date();
      const dia = String(hoy.getDate()).padStart(2, '0');
      const mes = String(hoy.getMonth() + 1).padStart(2, '0');
      const año = hoy.getFullYear();
      document.getElementById('fechaPago').value = `${dia}/${mes}/${año}`;

      $('#tablaFacturas').DataTable({
        language: { url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json" },
        columnDefs: [
          { orderable: false, targets: 0 }
        ]
      });

      // Manejar tecla F2 para buscar proveedores
      document.addEventListener('keydown', function(e) {
        if (e.key === 'F2') {
          e.preventDefault();
          mostrarModalProveedores();
        }
      });

      // Guardar pago
      document.getElementById("formPagoProveedor").addEventListener("submit", function(e) {
        e.preventDefault();
        
        const idproveedor = document.getElementById("idproveedor").value;
        if (!idproveedor) {
          alertify.error("Seleccione un proveedor");
          return;
        }

        // Obtener facturas seleccionadas
        const facturasSeleccionadas = [];
        document.querySelectorAll('#tablaFacturas input[type="checkbox"]:checked').forEach(checkbox => {
          const row = checkbox.closest('tr');
          const numFactura = row.cells[1].textContent;
          const total = parseInt(row.cells[4].textContent.replace(/[^\d]/g, ''));
          facturasSeleccionadas.push({ numFactura, total });
        });

        if (facturasSeleccionadas.length === 0) {
          alertify.error("Seleccione al menos una factura para pagar");
          return;
        }

        // Calcular importe total (sin decimales)
        const importeTotal = facturasSeleccionadas.reduce((sum, factura) => sum + factura.total, 0);

        // Crear objeto de pago
        const pago = {
          id: Date.now(),
          idproveedor: idproveedor,
          proveedor: document.getElementById("nombreProveedor").textContent,
          ruc: document.getElementById("rucProveedor").value,
          importe: importeTotal,
          fecha: document.getElementById("fechaPago").value,
          facturas: facturasSeleccionadas,
        };

        // Guardar pago
        const pagos = JSON.parse(localStorage.getItem("pagosProveedores")) || [];
        pagos.push(pago);
        localStorage.setItem("pagosProveedores", JSON.stringify(pagos));

        // Actualizar estado de las facturas
        const compras = JSON.parse(localStorage.getItem("compras")) || [];
        facturasSeleccionadas.forEach(factura => {
          const compraIndex = compras.findIndex(c => c.numFactura === factura.numFactura);
          if (compraIndex !== -1) {
            compras[compraIndex].estado = "pagado";
          }
        });
        localStorage.setItem("compras", JSON.stringify(compras));

        // Actualizar
        alertify.success(`Pago registrado a ${pago.proveedor}`);
        this.reset();
        document.getElementById("nombreProveedor").textContent = "No seleccionado";
        document.getElementById("rucProveedor").value = "";
        document.getElementById("idproveedor").value = "";
        $('#tablaFacturas').DataTable().clear().draw();
      });
    });

    function mostrarModalProveedores() {
      const proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
      const tabla = $('#tablaProveedoresModal').DataTable();
      tabla.clear();
      
      proveedores.forEach(proveedor => {
        tabla.row.add([
          proveedor.ruc,
          proveedor.proveedor,
          `<button class="btn btn-sm btn-success" onclick="seleccionarProveedor('${proveedor.id}', '${proveedor.ruc}', '${proveedor.proveedor}')">
            <i class="bi bi-check-lg"></i> Seleccionar
          </button>`
        ]);
      });
      tabla.draw();
      
      const modal = new bootstrap.Modal(document.getElementById('modalBuscarProveedor'));
      modal.show();
    }

    function seleccionarProveedor(id, ruc, nombre) {
      document.getElementById("idproveedor").value = id;
      document.getElementById("rucProveedor").value = ruc;
      document.getElementById("nombreProveedor").textContent = nombre;
      
      // Cargar facturas del proveedor
      cargarFacturasProveedor(id);
      
      // Cerrar modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('modalBuscarProveedor'));
      modal.hide();
    }

    function cargarFacturasProveedor(idProveedor) {
      const compras = JSON.parse(localStorage.getItem("compras")) || [];
      const facturasProveedor = compras.filter(c => 
        c.ruc === document.getElementById("rucProveedor").value && 
        c.estado !== "pagado"
      );
      
      const tabla = $('#tablaFacturas').DataTable();
      tabla.clear();
      
      let importeTotal = 0;
      
      facturasProveedor.forEach(factura => {
        importeTotal += factura.total;
        
        tabla.row.add([
          `<input type="checkbox" checked class="form-check-input factura-checkbox" data-monto="${factura.total}">`,
          factura.numFactura,
          factura.fecha,
          factura.condicion === "contado" ? "Contado" : "Crédito",
          `₲ ${factura.total.toLocaleString('es-PY')}`,
          factura.estado === "activo" ? "Pendiente" : factura.estado
        ]);
      });
      
      tabla.draw();
      document.getElementById("importeTotal").value = importeTotal;
      
      // Actualizar importe total cuando se seleccionan o deseleccionan facturas
      document.querySelectorAll('.factura-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          calcularImporteTotal();
        });
      });
    }

    function calcularImporteTotal() {
      let total = 0;
      document.querySelectorAll('#tablaFacturas input[type="checkbox"]:checked').forEach(checkbox => {
        total += parseInt(checkbox.dataset.monto);
      });
      document.getElementById("importeTotal").value = total;
    }

    function cerrarSesion() {
      sessionStorage.clear();
      window.location.href = "login.html";
    }
  </script>
</body>
</html>