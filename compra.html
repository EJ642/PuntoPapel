<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto Papel: Compra</title>
    <!-- Icono -->
    <link rel="icon" href="img/logo16px.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
    <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li id="opcArticulos"><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li id="opcProveedores"><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li id="opcMarcas"><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li id="opcCategorias"><a class="dropdown-item" href="categorias.html">Categorías</a></li>
                                <li id="opcClientes"><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                                <li id="opcUsuario"><a class="dropdown-item" href="usuario.html">Usuarios</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="compra.html">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="compras_hechas.html">Listado de compras</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li id="opcPagos"><a class="dropdown-item" href="pago_proveedores.html">Pago a Proveedores</a></li>
                                <li id="opcListado"><a class="dropdown-item" href="pagos_hechos.html">Listado de pagos</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuStock">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Stock
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ajuste_stock.html">Ajuste de Stock</a></li>
                                <li><a class="dropdown-item" href="ajustes_hechos.html">Listado de ajustes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="Registrodeventas.html">Registro de ventas</a></li>
                                <li id="opcListadoVentas"><a class="dropdown-item" href="ventas_realizadas.html">Listado de ventas</a></li>
                                <li id="opcCredito"><a class="dropdown-item" href="creditos_clientes.html">Créditos con clientes</a></li>
                                <li id="opcCobro"><a class="dropdown-item" href="historial_de pagos.html">Cobro de créditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="informe_venta.html">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="informe_credito.html">Informes de créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="informe_cobro_credito.html">Informes de cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="informeCompra.html">Informes de compras</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!" onclick="abrirPerfil()">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>    
    <!-- Pantalla principal donde se mostrará el contenido -->
    <div class="container my-4">
        <h1 class="text-center mb-4">Registrar Compras</h1>
        <form id="formCompras" class="p-3 bg-white shadow rounded">
            <!-- Cabecera compra -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    Datos del Proveedor
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label class="form-label">R.U.C.</label>
                        <div class="input-group">
                        <input type="text" id="ruc" class="form-control" required>
                        <button class="btn btn-outline-secondary" type="button" id="btnBuscarRuc" title="Buscar RUC">
                            <i class="bi bi-search"></i>
                        </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Proveedor</label>
                        <input type="text" id="proveedor" class="form-control" readonly required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Condición</label>
                        <select id="condicion" class="form-select">
                        <option value="contado">Contado</option>
                        <option value="credito">Crédito</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="fecha" class="form-control" required readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">N° Factura</label>
                        <input type="text" id="numfactura" class="form-control" required minlength="7" maxlength="15">
                    </div>
                </div>
            </div>
            <!-- Articulos -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white fw-bold">
                Agregar Artículo
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Código Articulo</label>
                        <input type="text" id="codbarra" class="form-control" required maxlength="13">
                        <input type="hidden" id="idarticulo">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Descripción</label>
                        <input type="text" id="descripcion" class="form-control text-uppercase" readonly>
                        <input type="hidden" id="iva">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Cantidad</label>
                        <input type="number" id="cantidad" class="form-control text-end" min="1" max="9999" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Precio Unitario</label>
                        <input type="text" id="preuni" class="form-control text-end" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Subtotal</label>
                        <input type="text" id="subtotal" class="form-control text-end" readonly>
                    </div>
                    <div class="col-md-1 d-grid align-items-end">
                        <button type="button" id="btnAgregarNuevoArticulo" class="btn btn-success" title="Agregar artículo">
                        <i class="bi bi-plus-square"></i>
                        </button>
                        <br>
                        <button type="button" id="btnAgregarArticulo" class="btn btn-success" title="Agregar artículo">
                        <i class="bi bi-cart-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Tabla de artículos -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white fw-bold">
                Detalle de la Compra
                </div>
                <div class="card-body">
                    <table id="tablaArticulos" class="table table-striped table-hover table-bordered">
                        <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>IVA</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                            <th class="d-none">ID Articulo</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- Botones de acción -->
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-primary" onclick="guardarCompra()">
                <i class="bi bi-save"></i> Guardar Compra
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
                </button>
                <a href="comprasHechas.html" class="btn btn-secondary">
                    <i class="bi bi-shop"></i> Listado de compras
                </a>
            </div>
        </form>
    </div>
    <!-- modal de proveedores -->
    <div class="modal fade" id="modalProveedores" tabindex="-1" aria-labelledby="modalProveedoresLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalProveedoresLabel">Seleccionar Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover" id="tablaProveedores">
                        <thead class="table-light">
                            <tr>
                                <th>RUC</th>
                                <th>Nombre</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- modal de articulos -->
    <div class="modal fade" id="modalArticulos" tabindex="-1" aria-labelledby="modalArticulosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalArticulosLabel">Seleccionar Artículo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover" id="tablaArticulosModal">
                        <thead class="table-light">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Marca</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div>
        <footer class="py-2 bg-white mt-auto border-top">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small text-muted">
                    <div>&copy; Librería Rocio 2025</div>
                </div>
            </div>
        </footer>
    </div>
    <!--Modal para editar el perfil del usuario -->
    <div class="modal fade" id="modalPerfilUsuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formPerfilUsuario" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="perfil_id">
                    <div class="mb-2">
                        <label>Nombre del Usuario</label>
                        <input type="text" id="perfil_nombre" class="form-control" readonly>
                    </div>
                    <div class="mb-2">
                        <label>Usuario</label>
                        <input type="text" id="perfil_usuario" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Contraseña</label>
                        <input type="password" id="perfil_contrasena" class="form-control" required>
                        <small id="mensajeSeguridad_perfil" class="form-text text-danger d-none">La contraseña no es segura.Debe tener al menos 8 caracteres, incluir una mayúscula, una minúscula, un número y un caracter especial.</small>
                    </div>
                    <div class="mb-2">
                        <label>Confirmar Contraseña</label>
                        <input type="password" id="perfil_confirmar" class="form-control" required>
                        <small id="mensajeCoincidencia_perfil" class="form-text text-danger d-none"> Las contraseñas no coinciden</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/permisos.js"></script>
    <script src="js/bd.js"></script>
    <script src="js/perfil.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>
    <script>
        // control de seguridad al cargarse la página
        document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "error.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });
        let detalleCompra = [];
        document.addEventListener("DOMContentLoaded", function(){
            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("fecha").max = hoy;
            document.getElementById("fecha").value = hoy;

            document.getElementById("cantidad").addEventListener("input", calcularSubtotalArticulo);

            const inputFactura = document.getElementById("numfactura");
            inputFactura.addEventListener("input", function () {
                let valor = inputFactura.value.replace(/\D/g, ""); // quita todo lo que no sea número
                if (valor.length > 13) valor = valor.slice(0, 13); // máximo 13 dígitos
                // Inserta guiones automáticamente
                let formateado = "";
                if (valor.length <= 3) {
                    formateado = valor;
                } else if (valor.length <= 6) {
                    formateado = valor.slice(0, 3) + "-" + valor.slice(3);
                } else {
                    formateado = valor.slice(0, 3) + "-" + valor.slice(3, 6) + "-" + valor.slice(6);
                }

                inputFactura.value = formateado;
            });
        });
        // funcion del boton buscar ruc
        document.getElementById("btnBuscarRuc").addEventListener("click", function(){
            const rucIngresado = document.getElementById("ruc").value.trim();
            const proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
            const proveedor = proveedores.find(p => p.ruc === rucIngresado);
            if (proveedor) {
                document.getElementById("proveedor").value = proveedor.proveedor;
                alertify.success("Proveedor encontrado.");
            } else {
                document.getElementById("proveedor").value = "";
                alertify.error("Proveedor no encontrado.");
            }
        });
        function calcularSubtotalArticulo(){
            const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
            const precioUnitario = parseInt(document.getElementById("preuni").value) || 0;
            const subtotal = cantidad * precioUnitario;
            document.getElementById("subtotal").value = subtotal;
        }
        // funcion del boton agregar los articulos que se compraran
        document.getElementById("btnAgregarArticulo").addEventListener("click", function(){
            const codBarra = document.getElementById("codbarra").value.trim();
            const descripcion = document.getElementById("descripcion").value.trim();
            const cantidad = parseInt(document.getElementById("cantidad").value);
            const precioUnitario = parseInt(document.getElementById("preuni").value);
            const iva = parseInt(document.getElementById("iva").value);
            // verifica que todos los campos se completen
            if(!codBarra || !descripcion || isNaN(cantidad) || isNaN(precioUnitario)){
                alertify.error("Completa todos los campos del artículo");
                return;
            }
            if(precioUnitario <= 0){
                alertify.error("No se admiten números negativos ni cero");
                document.getElementById("preuni").value = "";
                document.getElementById("preuni").focus();
                return;
            }
            const precioConIVA = precioUnitario + (precioUnitario * iva / 100);
            const subtotal = cantidad * precioConIVA;
            detalleCompra.push({
                codBarra,
                descripcion,
                cantidad,
                precioUnitario,
                iva,
                subtotal
            });
            mostrarDetalleEnTabla();
            limpiarCamposArticulo();
        });
        // autocompletar los articulos
        document.getElementById("codbarra").addEventListener("change", function () {
            const codigo = parseInt(this.value);
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            const articulo = articulos.find(a => a.codigo === codigo);
            if(articulo) {
                document.getElementById("descripcion").value = articulo.nombre_articulo;
                document.getElementById("idarticulo").value = articulo.idarticulo;
                document.getElementById("iva").value = articulo.iva; 
                document.getElementById("preuni").value = articulo.costo;
                document.getElementById("cantidad").focus();
                calcularSubtotalArticulo();
            }else {
                alertify.error("Artículo no encontrado.");
                document.getElementById("descripcion").value = "";
                document.getElementById("preuni").value = "";
                document.getElementById("iva").value = "";
            }
        });
        // funcion para mostrar el detalle en la table
        function mostrarDetalleEnTabla(){
            const tbody = document.querySelector("#tablaArticulos tbody");
            tbody.innerHTML = "";
            let total = 0;
            detalleCompra.forEach((item, index)=> {
                total += item.subtotal;
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.codBarra}</td>
                    <td>${item.descripcion}</td>
                    <td class="text-end">${item.cantidad}</td> 
                    <td class="text-end">${item.precioUnitario}</td> 
                    <td>${item.iva}</td>
                    <td class="text-end">${item.subtotal}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger" onclick="eliminarArticulo(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td class="d-none"></td>
                    `;
                    tbody.appendChild(fila);
            });
            document.getElementById("subtotal").value = total;
        }
        // funcion para limpiar campos articulos
        function limpiarCamposArticulo(){
            document.getElementById("codbarra").value = "";
            document.getElementById("descripcion").value = "";
            document.getElementById("cantidad").value = 1;
            document.getElementById("preuni").value = "";
            document.getElementById("subtotal").value = "";
        }
        // funcion para eliminar articulo
        function eliminarArticulo(index) {
            detalleCompra.splice(index, 1);
            mostrarDetalleEnTabla();
        }
        // funcion para guardar compra
        function guardarCompra(){   
            const ruc = document.getElementById("ruc").value.trim();
            const proveedor = document.getElementById("proveedor").value.trim();
            const condicion = document.getElementById("condicion").value;
            const fecha = document.getElementById("fecha").value;
            const numFactura = document.getElementById("numfactura").value.trim();
            const total = detalleCompra.reduce((sum, item) => sum + (item.precioUnitario * item.cantidad * (1 + item.iva / 100)), 0);
            // verifica que todos los campos se completen
            if (!ruc || !proveedor || !fecha || !numFactura || detalleCompra.length === 0) {
                alertify.error("Completa todos los campos de la cabecera y agrega al menos un artículo.");
                return;
            }
            let comprasGuardadas = JSON.parse(localStorage.getItem("compras")) || [];
            let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            let proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
            const facturaDuplicada = comprasGuardadas.some(c => c.ruc === ruc && c.numFactura === numFactura);
            if (facturaDuplicada) {
                alertify.error("Este número de factura ya fue cargado para este proveedor.");
                return;
            }
            const nuevaCompra = {
                idCompra: obtenerSiguienteId(comprasGuardadas),
                ruc,
                proveedor,
                condicion,
                fecha,
                numFactura,
                total,
                estado: "activo",
                detalle: detalleCompra
            };
            comprasGuardadas.push(nuevaCompra);
            localStorage.setItem("compras", JSON.stringify(comprasGuardadas));
            // actualiza el stock de cada articulo
            nuevaCompra.detalle.forEach(item => {
                const art = articulos.find(a => a.codigo === parseInt(item.codBarra));
                if(art){
                    art.stock += item.cantidad;
                }
            });
            localStorage.setItem("articulos", JSON.stringify(articulos));
            // Actualizar saldo del proveedor si es crédito
            if (condicion === "credito") {
                const proveedorIndex = proveedores.findIndex(p => p.ruc === ruc);
                if (proveedorIndex !== -1) {
                    // Si el proveedor no tiene saldo, inicializarlo en 0
                    if (!proveedores[proveedorIndex].saldo) {
                        proveedores[proveedorIndex].saldo = 0;
                    }
                    // Aumentar el saldo con el total de la compra
                    proveedores[proveedorIndex].saldo += total;
                    localStorage.setItem("proveedores", JSON.stringify(proveedores));
                    
                    alertify.success(`Compra guardada. Saldo del proveedor actualizado: ${proveedores[proveedorIndex].saldo}`);
                } else {
                    alertify.error("Proveedor no encontrado para actualizar saldo.");
                }
            } else {
                alertify.success("Compra al contado guardada correctamente");
            }
            // Limpiar todo
            detalleCompra = [];
            document.getElementById("formCompras").reset();
            mostrarDetalleEnTabla();
        }
        // funcion para mostrar el modal de proveedores
        function mostrarModalProveedores(){
            const tbody = document.querySelector("#tablaProveedores tbody");
            tbody.innerHTML = "";
            const proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
            proveedores.forEach(p => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${p.ruc}</td>
                <td>${p.proveedor}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="seleccionarProveedor('${p.ruc}', '${p.proveedor}')">
                        Seleccionar
                    </button>
                </td>
                `;
                tbody.appendChild(fila);
            });
            const modal = new bootstrap.Modal(document.getElementById("modalProveedores"));
            modal.show();
        }
        // funcion para seleccionar el proveedor
        function seleccionarProveedor(ruc, proveedor) {
            document.getElementById("ruc").value = ruc;
            document.getElementById("proveedor").value = proveedor;
            bootstrap.Modal.getInstance(document.getElementById("modalProveedores")).hide();
            alertify.success("Proveedor seleccionado");
        }
        // funcion para detectar el F2
        document.addEventListener("keydown", function(e){
            if(e.key === "F2"){
                e.preventDefault();
                mostrarModalProveedores();
            }
        });
        // funcion para mostrar el modal de articulos
        function mostrarModalArticulos(){
            const tbody = document.querySelector("#tablaArticulosModal tbody");
            tbody.innerHTML = "";
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            articulos.forEach(a => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${a.codigo}</td>
                <td>${a.nombre_articulo}</td>
                <td>${a.marcas}</td>
                <td>${a.costo}</td>
                <td>${a.stock}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="seleccionarArticulo(${a.codigo})">
                        Seleccionar
                    </button>
                </td>
                `;
                tbody.appendChild(fila);
            });
            const modal = new bootstrap.Modal(document.getElementById("modalArticulos"));
            modal.show();
        }
        // funcion para seleccionar el articulo
        function seleccionarArticulo(codigo) {
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            const articulo = articulos.find(a => a.codigo === codigo);
            if (articulo) {
                document.getElementById("codbarra").value = articulo.codigo;
                document.getElementById("descripcion").value = articulo.nombre_articulo;
                document.getElementById("idarticulo").value = articulo.idarticulo;
                document.getElementById("iva").value = articulo.iva;
                document.getElementById("preuni").value = articulo.costo;
                document.getElementById("cantidad").value = 1;
                calcularSubtotalArticulo();

                bootstrap.Modal.getInstance(document.getElementById("modalArticulos")).hide();
                alertify.success("Artículo seleccionado");
            } else {
                alertify.error("No se pudo cargar el artículo");
            }
        }
        // funcion para detectar el F3
        document.addEventListener("keydown", function(e){
            if(e.key === "F3"){
                e.preventDefault();
                mostrarModalArticulos();
            }
        });
        function obtenerSiguienteId(compras) {
            if (compras.length === 0){
                return 1;
            }else{
                const maxId = Math.max(...compras.map(u => u.idCompra || 0));
                return maxId + 1;
            }
        }
        //funcion que oculta elementos del menu dependiendo del rol
        document.addEventListener("DOMContentLoaded", function () {
            const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!rol || !nombre) {
                alertify.error("Acceso denegado.");
                window.location.href = "login.html";
                return;
            }
            // Mostrar el nombre en el panel
            const spanUsuario = document.getElementById("usuario");
            if (spanUsuario) spanUsuario.textContent = nombre;
            
            // Ocultar menús según el rol
            switch (rol) {
                case "administrador":
                    // ve todo
                    break;
                case "gerente":
                    ocultar(["menuMantenimiento", "menuCompras", "menuStock", "menuVentas"]);
                    break;
                case "cajero":
                    ocultar(["menuMantenimiento", "menuCompras", "menuStock", "opcCobro", "opcCredito", "opcListadoVentas", "menuInformes"]);
                    break;
                case "codificador":
                    ocultar(["opcUsuario", "opcClientes", "menuVentas", "opcPagos", "opcListado", "menuStock", "menuInformes"]);
                    break;
                default:
                    alertify.error("Rol no válido.");
                    window.location.href = "login.html";
            }
            // Función para ocultar elementos por ID
            function ocultar(ids) {
                ids.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.style.display = "none";
                });
            }
        });
        // reglas para el perfil
        document.addEventListener("DOMContentLoaded", function () {
            const reglas = {
                r1: c => c.length >= 8,
                r2: c => /[A-Z]/.test(c),
                r3: c => /[a-z]/.test(c),
                r4: c => /\d/.test(c),
                r5: c => /[@#$%^&+=!¡¿?*()\-_"':;.,<>~`|{}\[\]\\]/.test(c),
            };
            function mostrarSeguridad(inputId, mensajeId) {
                const input = document.getElementById(inputId);
                const mensaje = document.getElementById(mensajeId);
                if (!input || !mensaje) return;
                input.addEventListener("input", () => {
                    const contra = input.value;
                    const cumple = Object.values(reglas).every(fn => fn(contra));
                    if (contra === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    mensaje.classList.remove("d-none");
                    if (cumple) {
                        mensaje.textContent = "🟢 Contraseña segura";
                        mensaje.classList.remove("text-danger");
                        mensaje.classList.add("text-success");
                    } else {
                        mensaje.textContent = "La contraseña no es segura. Debe tener al menos 8 caracteres, incluir una mayúscula, una minúscula, un número y un caracter especial.";
                        mensaje.classList.remove("text-success");
                        mensaje.classList.add("text-danger");
                    }
                });
            }
            // Validación al enviar formulario
            [
                { formId: "formPerfilUsuario", passId: "perfil_contrasena", confId: "perfil_confirmar" },
            ].forEach(({ formId, passId, confId }) => {
                const form = document.getElementById(formId);
                form.addEventListener("submit", function (e) {
                const contra = document.getElementById(passId).value;
                const confContra = document.getElementById(confId).value;
                const cumple = Object.values(reglas).every(fn => fn(contra));

                if (!cumple) {
                    e.preventDefault();
                    alertify.error("La contraseña no es segura.");
                } else if (contra !== confContra) {
                    e.preventDefault();
                    alertify.warning("Las contraseñas no coinciden.");
                }
                });
            });
            // función para verificar coincidencia de contraseñas
            function verificarCoincidencia(passId, confId, mensajeId) {
                const pass = document.getElementById(passId);
                const conf = document.getElementById(confId);
                const mensaje = document.getElementById(mensajeId);
                function checkMatch() {
                    if (conf.value === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    if (pass.value === conf.value) {
                        mensaje.classList.add("d-none");
                    } else {
                        mensaje.textContent = "Las contraseñas no coinciden";
                        mensaje.classList.remove("d-none");
                    }
                }
                pass.addEventListener("input", checkMatch);
                conf.addEventListener("input", checkMatch);
            }
            mostrarSeguridad("perfil_contrasena", "mensajeSeguridad_perfil");
            verificarCoincidencia("perfil_contrasena", "perfil_confirmar", "mensajeCoincidencia_perfil");
        });
    </script>
</body>
</html>
