<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto Papel</title>
    <!-- Icono -->
    <link rel="icon" href="img/user128.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- ESTILOS DEL MENU -->
    <link rel="stylesheet" href="menu/styles.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
    <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li><a class="dropdown-item" href="categorias.html">Clasificaciones</a></li>
                                <li><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="pago_proveedores.html">Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ventas.html">Registro de ventas</a></li>
                                <li><a class="dropdown-item" href="credito_Cliente.html">Créditos con clientes</a></li>
                                <li><a class="dropdown-item" href="#">Cobró de creditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="#">Informes de Cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="#">Informes de compras</a></li>
                                <li><a class="dropdown-item" href="#">Informes de créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item" id="menuUsuarios"></li>
                            <a class="nav-link" href="usuario.html">Usuarios</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Configuraciones</a></li>
                            <li><a class="dropdown-item" href="#!">Actividad</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- Pantalla principal donde se mostrará el contenido -->
    <div class="container my-4">
        <h1 class="text-center mb-4">Registrar Compras</h1>
        <form id="formCompras" class="p-3 bg-white shadow rounded">
            <!-- Cabecera compra -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white fw-bold">
                    Datos del Proveedor
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-3">
                        <label class="form-label">R.U.C.</label>
                        <div class="input-group">
                        <input type="text" id="ruc" class="form-control" required>
                        <button class="btn btn-outline-secondary" type="button" id="btnBuscarRuc" title="Buscar RUC">
                            <i class="bi bi-search"></i>
                        </button>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Proveedor</label>
                        <input type="text" id="proveedor" class="form-control" readonly required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Condición</label>
                        <select id="condicion" class="form-select">
                        <option value="contado">Contado</option>
                        <option value="credito">Crédito</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="fecha" class="form-control" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">N° Factura</label>
                        <input type="text" id="numfactura" class="form-control" required minlength="7" maxlength="15">
                    </div>
                </div>
            </div>
            <!-- Articulos -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white fw-bold">
                Agregar Artículo
                </div>
                <div class="card-body row g-3">
                    <div class="col-md-2">
                        <label class="form-label">Código Articulo</label>
                        <input type="text" id="codbarra" class="form-control" required maxlength="13">
                        <input type="hidden" id="idarticulo">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Descripción</label>
                        <input type="text" id="descripcion" class="form-control text-uppercase" readonly>
                        <input type="hidden" id="iva">
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Cantidad</label>
                        <input type="number" id="cantidad" class="form-control text-end" min="1" max="9999" value="1" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Precio Unitario</label>
                        <input type="text" id="preuni" class="form-control text-end" required readonly>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Subtotal</label>
                        <input type="text" id="subtotal" class="form-control text-end" readonly>
                    </div>
                    <div class="col-md-1 d-grid align-items-end">
                        <button type="button" id="btnAgregarNuevoArticulo" class="btn btn-success" title="Agregar artículo">
                        <i class="bi bi-plus-square"></i>
                        </button>
                        <br>
                        <button type="button" id="btnAgregarArticulo" class="btn btn-success" title="Agregar artículo">
                        <i class="bi bi-cart-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <!-- Tabla de artículos -->
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white fw-bold">
                Detalle de la Compra
                </div>
                <div class="card-body">
                    <table id="tablaArticulos" class="table table-striped table-hover table-bordered">
                        <thead class="table-light">
                        <tr>
                            <th>#</th>
                            <th>Código</th>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>IVA</th>
                            <th>Subtotal</th>
                            <th>Acción</th>
                            <th class="d-none">ID Articulo</th>
                        </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <!-- Botones de acción -->
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-primary" onclick="guardarCompra()">
                <i class="bi bi-save"></i> Guardar Compra
                </button>
                <button type="reset" class="btn btn-outline-secondary">
                <i class="bi bi-x-circle"></i> Limpiar
                </button>
                <a href="comprasHechas.html" class="btn btn-secondary">
                    <i class="bi bi-square-fill"></i> Listado de compras
                </a>
            </div>
        </form>
    </div>
    <!-- modal de proveedores -->
    <div class="modal fade" id="modalProveedores" tabindex="-1" aria-labelledby="modalProveedoresLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalProveedoresLabel">Seleccionar Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover" id="tablaProveedores">
                        <thead class="table-light">
                            <tr>
                                <th>RUC</th>
                                <th>Nombre</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- modal de articulos -->
    <div class="modal fade" id="modalArticulos" tabindex="-1" aria-labelledby="modalArticulosLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalArticulosLabel">Seleccionar Proveedor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <table class="table table-bordered table-hover" id="tablaArticulosModal">
                        <thead class="table-light">
                            <tr>
                                <th>Código</th>
                                <th>Nombre</th>
                                <th>Marca</th>
                                <th>Precio</th>
                                <th>Stock</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- modal para cargar nuevos articulos -->

    <div>
        <footer class="py-2 bg-white mt-auto border-top">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small text-muted">
                    <div>&copy; Librería Rocio 2025</div>
                </div>
            </div>
        </footer>
    </div>
    <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/auth/permisos.js"></script>
    <script src="js/bd.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>
    <script>
        // control de seguridad al cargarse la página
        /*document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "error.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });*/
        let detalleCompra = [];
        document.addEventListener("DOMContentLoaded", function(){
            const hoy = new Date().toISOString().split("T")[0];
            document.getElementById("fecha").max = hoy;
            document.getElementById("fecha").value = hoy;

            document.getElementById("cantidad").addEventListener("input", calcularSubtotalArticulo);

            const inputFactura = document.getElementById("numfactura");
            inputFactura.addEventListener("input", function () {
                let valor = inputFactura.value.replace(/\D/g, ""); // quita todo lo que no sea número
                if (valor.length > 13) valor = valor.slice(0, 13); // máximo 13 dígitos
                // Inserta guiones automáticamente
                let formateado = "";
                if (valor.length <= 3) {
                    formateado = valor;
                } else if (valor.length <= 6) {
                    formateado = valor.slice(0, 3) + "-" + valor.slice(3);
                } else {
                    formateado = valor.slice(0, 3) + "-" + valor.slice(3, 6) + "-" + valor.slice(6);
                }

                inputFactura.value = formateado;
            });
        });
        // funcion del boton buscar ruc
        document.getElementById("btnBuscarRuc").addEventListener("click", function(){
            const rucIngresado = document.getElementById("ruc").value.trim();
            const proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
            const proveedor = proveedores.find(p => p.ruc === rucIngresado);
            if (proveedor) {
                document.getElementById("proveedor").value = proveedor.proveedor;
                alertify.success("Proveedor encontrado.");
            } else {
                document.getElementById("proveedor").value = "";
                alertify.error("Proveedor no encontrado.");
            }
        });
        function calcularSubtotalArticulo(){
            const cantidad = parseInt(document.getElementById("cantidad").value) || 0;
            const precioUnitario = parseInt(document.getElementById("preuni").value) || 0;
            const subtotal = cantidad * precioUnitario;
            document.getElementById("subtotal").value = subtotal;
        }
        // funcion del boton agregar los articulos que se compraran
        document.getElementById("btnAgregarArticulo").addEventListener("click", function(){
            const codBarra = document.getElementById("codbarra").value.trim();
            const descripcion = document.getElementById("descripcion").value.trim();
            const cantidad = parseInt(document.getElementById("cantidad").value);
            const precioUnitario = parseInt(document.getElementById("preuni").value);
            const iva = parseInt(document.getElementById("iva").value) || 0;
            // verifica que todos los campos se completen
            if(!codBarra || !descripcion || isNaN(cantidad) || isNaN(precioUnitario)){
                alertify.error("Completa todos los campos del artículo");
                return;
            }
            const subtotal = cantidad * precioUnitario;
            detalleCompra.push({
                codBarra,
                descripcion,
                cantidad,
                precioUnitario,
                iva,
                subtotal
            });
            mostrarDetalleEnTabla();
            limpiarCamposArticulo();
        });
        // autocompletar los articulos
        document.getElementById("codbarra").addEventListener("change", function () {
            const codigo = parseInt(this.value);
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            const articulo = articulos.find(a => a.codigo === codigo);
            if(articulo) {
                document.getElementById("descripcion").value = articulo.nombre;
                document.getElementById("idarticulo").value = articulo.id;
                document.getElementById("iva").value = articulo.iva; 
                document.getElementById("preuni").value = articulo.costo;
                document.getElementById("cantidad").focus();
                calcularSubtotalArticulo();
            }else {
                alertify.error("Artículo no encontrado.");
                document.getElementById("descripcion").value = "";
                document.getElementById("preuni").value = "";
                document.getElementById("iva").value = "";
            }
        });
        // funcion para mostrar el detalle en la table
        function mostrarDetalleEnTabla(){
            const tbody = document.querySelector("#tablaArticulos tbody");
            tbody.innerHTML = "";
            let total = 0;
            detalleCompra.forEach((item, index)=> {
                total += item.subtotal;
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.codBarra}</td>
                    <td>${item.descripcion}</td>
                    <td class="text-end">${item.cantidad}</td> 
                    <td class="text-end">${item.precioUnitario}</td> 
                    <td>${item.iva}</td>
                    <td class="text-end">${item.subtotal}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-danger" onclick="eliminarArticulo(${index})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                    <td class="d-none"></td>
                    `;
                    tbody.appendChild(fila);
            });
            document.getElementById("subtotal").value = total;
        }
        // funcion para limpiar campos articulos
        function limpiarCamposArticulo() {
            document.getElementById("codbarra").value = "";
            document.getElementById("descripcion").value = "";
            document.getElementById("cantidad").value = 1;
            document.getElementById("preuni").value = "";
            document.getElementById("subtotal").value = "";
        }
        // funcion para eliminar articulo
        function eliminarArticulo(index) {
            detalleCompra.splice(index, 1);
            mostrarDetalleEnTabla();
        }
        // funcion para guardar compra
        function guardarCompra(){
            const ruc = document.getElementById("ruc").value.trim();
            const proveedor = document.getElementById("proveedor").value.trim();
            const condicion = document.getElementById("condicion").value;
            const fecha = document.getElementById("fecha").value;
            const numFactura = document.getElementById("numfactura").value.trim();
            const total = detalleCompra.reduce((sum, item) => sum + item.subtotal, 0);
            // verifica que todos los campos se completen
            if (!ruc || !proveedor || !fecha || !numFactura || detalleCompra.length === 0) {
                alertify.error("Completa todos los campos de la cabecera y agrega al menos un artículo.");
                return;
            }
            let comprasGuardadas = JSON.parse(localStorage.getItem("compras")) || [];
            const facturaDuplicada = comprasGuardadas.some(c => c.ruc === ruc && c.numFactura === numFactura);
            if (facturaDuplicada) {
                alertify.error("Este número de factura ya fue cargado para este proveedor.");
                return;
            }
            const nuevaCompra = {
                idCompra: obtenerSiguienteId(comprasGuardadas),
                ruc,
                proveedor,
                condicion,
                fecha,
                numFactura,
                total,
                estado: "activo",
                detalle: detalleCompra
            };
            comprasGuardadas.push(nuevaCompra);
            localStorage.setItem("compras", JSON.stringify(comprasGuardadas));
            alertify.success("Compra Guardada Correctamente");
            // Limpiar todo
            detalleCompra = [];
            document.getElementById("formCompras").reset();
            mostrarDetalleEnTabla();
        }
        // funcion para mostrar el modal de proveedores
        function mostrarModalProveedores(){
            const tbody = document.querySelector("#tablaProveedores tbody");
            tbody.innerHTML = "";
            const proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];
            proveedores.forEach(p => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${p.ruc}</td>
                <td>${p.proveedor}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="seleccionarProveedor('${p.ruc}', '${p.proveedor}')">
                        Seleccionar
                    </button>
                </td>
                `;
                tbody.appendChild(fila);
            });
            const modal = new bootstrap.Modal(document.getElementById("modalProveedores"));
            modal.show();
        }
        // funcion para seleccionar el proveedor
        function seleccionarProveedor(ruc, proveedor) {
            document.getElementById("ruc").value = ruc;
            document.getElementById("proveedor").value = proveedor;
            bootstrap.Modal.getInstance(document.getElementById("modalProveedores")).hide();
            alertify.success("Proveedor seleccionado");
        }
        // funcion para detectar el F2
        document.addEventListener("keydown", function(e){
            if(e.key === "F2"){
                e.preventDefault();
                mostrarModalProveedores();
            }
        });
        // funcion para mostrar el modal de articulos
        function mostrarModalArticulos(){
            const tbody = document.querySelector("#tablaArticulosModal tbody");
            tbody.innerHTML = "";
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            articulos.forEach(a => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                <td>${a.codigo}</td>
                <td>${a.nombre}</td>
                <td>${a.marcas}</td>
                <td>${a.precio}</td>
                <td>${a.stock}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="seleccionarArticulo(${a.codigo})">
                        Seleccionar
                    </button>
                </td>
                `;
                tbody.appendChild(fila);
            });
            const modal = new bootstrap.Modal(document.getElementById("modalArticulos"));
            modal.show();
        }
        // funcion para seleccionar el articulo
        function seleccionarArticulo(codigo) {
            const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            const articulo = articulos.find(a => a.codigo === codigo);
            if (articulo) {
                document.getElementById("codbarra").value = articulo.codigo;
                document.getElementById("descripcion").value = articulo.nombre;
                document.getElementById("idarticulo").value = articulo.id;
                document.getElementById("iva").value = articulo.iva || 0;
                document.getElementById("preuni").value = articulo.costo;
                document.getElementById("cantidad").value = 1;
                calcularSubtotalArticulo();

                bootstrap.Modal.getInstance(document.getElementById("modalArticulos")).hide();
                alertify.success("Artículo seleccionado");
            } else {
                alertify.error("No se pudo cargar el artículo");
            }
        }
        // funcion para detectar el F3
        document.addEventListener("keydown", function(e){
            if(e.key === "F3"){
                e.preventDefault();
                mostrarModalArticulos();
            }
        });
        function obtenerSiguienteId(compras) {
            if (compras.length === 0){
                return 1;
            }else{
                const maxId = Math.max(...compras.map(u => u.idCompra || 0));
                return maxId + 1;
            }
        }
    </script>
</body>
</html>
