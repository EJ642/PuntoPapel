<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ventas</title>
    <!-- Icono -->
    <link rel="icon" href="img/user128.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
  <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li id="opcArticulos"><a class="dropdown-item" href="articulos.html">Art√≠culos</a></li>
                                <li id="opcProveedores"><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li id="opcMarcas"><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li id="opcCategorias"><a class="dropdown-item" href="categorias.html">Categor√≠as</a></li>
                                <li id="opcClientes"><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                                <li id="opcUsuario"><a class="dropdown-item" href="usuario.html">Usuarios</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="compra.html">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="compras_hechas.html">Listado de compras</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li id="opcPagos"><a class="dropdown-item" href="pago_proveedores.html">Pago a Proveedores</a></li>
                                <li id="opcListado"><a class="dropdown-item" href="pagos_hechos.html">Listado de pagos</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuStock">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Stock
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ajuste_stock.html">Ajuste de Stock</a></li>
                                <li><a class="dropdown-item" href="ajustes_hechos.html">Listado de ajustes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="Registrodeventas.html">Registro de ventas</a></li>
                                <li id="opcListadoVentas"><a class="dropdown-item" href="ventas_realizadas.html">Listado de ventas</a></li>
                                <li id="opcCredito"><a class="dropdown-item" href="creditos_clientes.html">Cr√©ditos con clientes</a></li>
                                <li id="opcCobro"><a class="dropdown-item" href="historial_de pagos.html">Cobro de cr√©ditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="informe_venta.html">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="informe_credito.html">Informes de cr√©ditos con clientes </a></li>
                                <li><a class="dropdown-item" href="informe_cobro_credito.html">Informes de cobr√≥ de cr√©ditos</a></li>
                                <li><a class="dropdown-item" href="informeCompra.html">Informes de compras</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!" onclick="abrirPerfil()">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesi√≥n</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>    
  <!-- CONTENEDOR PRINCIPAL -->
  <div class="container mt-4 cont-principal">
    <h2 class="mb-4"><i class="bi bi-cash-coin"></i> Registro de Ventas</h2>
    <form id="formCompras" class="p-3 bg-white shadow rounded">
      <!-- SECCI√ìN CLIENTE -->
      <div class="card p-4 mb-4 shadow-sm">
        <h5 class="mb-3">Datos del Cliente</h5>
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="cliente" class="form-label">Nombre</label>
            <div class="input-group">
              <input type="text" class="form-control" id="cliente" value="VENTA AL P√öBLICO" readonly placeholder="Nombre del cliente">
              <button type="button" class="btn btn-outline-secondary" onclick="mostrarModalClientes()">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-4">
            <label for="ruc" class="form-label">RUC</label>
            <input type="text" class="form-control" id="ruc" placeholder="RUC">
          </div>
          <div class="col-md-4">
            <label for="direccion" class="form-label">Direcci√≥n</label>
            <input type="text" class="form-control" id="direccion" readonly placeholder="Direcci√≥n">
          </div>

          <div class="col-md-4">
            <label for="condicionPago" class="form-label">Condici√≥n de Pago</label>
            <select class="form-select" id="condicionPago" onchange="mostrarFechaVencimiento()">
              <option value="contado">Contado</option>
              <option value="cr√©dito">Cr√©dito</option>
            </select>
          </div>

          <div class="col-md-4" id="grupoFechaVencimiento" style="display: none;">
            <label for="fechaVencimiento" class="form-label">Fecha de Vencimiento</label>
            <input type="date" class="form-control" id="fechaVencimiento">
          </div>
        </div>
      </div>

      <!-- FECHA Y FACTURA -->
      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <label for="fecha" class="form-label">Fecha</label>
          <input type="text" class="form-control" id="fecha" readonly>
        </div>
        <div class="col-md-6">
          <label for="factura" class="form-label">N¬∞ Factura</label>
          <input type="text" class="form-control" id="factura" readonly>
        </div>
      </div>

      <!-- DETALLE DE VENTA -->
      <div class="card p-4 mb-4 shadow-sm">
        <h5 class="mb-3">Detalle de Venta</h5>
        <div class="row g-3 align-items-end">
          <div class="col-md-5">
            <label class="form-label">C√≥digo del Producto</label>
            <div class="input-group">
              <input type="text" class="form-control" id="producto" placeholder="C√≥digo del producto">
              <button type="button" class="btn btn-outline-secondary" onclick="mostrarModalArticulos()">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-3">
            <label for="descripcion" class="form-label">Descripci√≥n</label>
            <input type="text" class="form-control" id="descripcion" placeholder="Descripci√≥n" readonly>
          </div>
          <div class="col-md-2">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input type="number" class="form-control" id="cantidad" placeholder="Cantidad" min="1" value="1" required>
          </div>
          <div class="col-md-3">
            <label for="precioUnit" class="form-label">Precio Unitario</label>
            <input type="text" class="form-control" id="precioUnit" placeholder="Precio Unitario" readonly>
          </div>
          <div class="col-md-2">
            <button type="button" class="btn btn-primary w-100" onclick="agregarProducto()">A√±adir</button>
          </div>
        </div>
      </div>

      <!-- TABLA DETALLE DE VENTA -->
      <div class="table-responsive mb-4">
        <table class="table table-bordered table-hover text-center align-middle" id="tablaDetalle">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Descripci√≥n</th>
              <th>Cant.</th>
              <th>Pre. Unit</th>
              <th>IVA</th>
              <th>Subtotal</th>
              <th>Acci√≥n</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- TOTAL Y BOT√ìN -->
      <div class="row mb-5">
        <div class="col text-end">
          <h5>Total: Gs. <span id="total"></span></h5>
          <button type="button" class="btn btn-success mt-2" onclick="registrarVenta()">
            Generar Venta
          </button>
        </div>
      </div>
    </form>
  </div>
  <!-- Modal: Resumen de Venta -->
  <div class="modal fade" id="modalVenta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Resumen de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="modalTotal" class="form-label">Total a Pagar</label>
          <input type="text" class="form-control mb-2" id="modalTotal" readonly>

          <label for="efectivo" class="form-label">Efectivo Recibido</label>
          <input type="number" class="form-control mb-2" id="efectivo">

          <label for="cambio" class="form-label">Cambio</label>
          <input type="text" class="form-control mb-2" id="cambio" readonly>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="guardarVenta('contado')">Registrar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Contenedor oculto del ticket -->
  <div id="comprobanteTicket" style="display: none;"></div>
  <!-- modal seleccion cliente -->
  <div class="modal fade" id="modalClientes" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Seleccionar Cliente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered" id="tablaClientes">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>RUC</th>
                <th>Direcci√≥n</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <!-- modal seleccion producto -->
  <div class="modal fade" id="modalArticulos" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title">Seleccionar Art√≠culo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered" id="tablaArticulosModal">
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Precio</th>
                <th>IVA</th>
                <th>Acci√≥n</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para Autenticaci√≥n de Administrador -->
  <div class="modal fade" id="modalAdmin" tabindex="-1" aria-labelledby="modalAdminLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content p-3">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAdminLabel">Autenticaci√≥n de Administrador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="adminUsuario">Usuario Administrador</label>
          <input type="text" class="form-control mb-2" id="adminUsuario" placeholder="Usuario">

          <label for="adminPassword">Contrase√±a</label>
          <input type="password" class="form-control mb-2" id="adminPassword" placeholder="Contrase√±a">
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="verificarAdmin()">Autorizar</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal del Comprobante -->
  <div class="modal fade" id="modalComprobanteVenta" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">üßæ Comprobante de Venta</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="contenidoComprobanteVenta" class="p-2"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="imprimirComprobanteVenta()">üñ®Ô∏è Imprimir</button>
          <button class="btn btn-danger" onclick="exportarPDFComprobante()">üìÑ PDF</button>
        </div>
      </div>
    </div>
  </div>
  <!--Modal para editar el perfil del usuario -->
    <div class="modal fade" id="modalPerfilUsuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formPerfilUsuario" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="perfil_id">
                    <div class="mb-2">
                        <label>Nombre del Usuario</label>
                        <input type="text" id="perfil_nombre" class="form-control" readonly>
                    </div>
                    <div class="mb-2">
                        <label>Usuario</label>
                        <input type="text" id="perfil_usuario" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Contrase√±a</label>
                        <input type="password" id="perfil_contrasena" class="form-control" required>
                        <small id="mensajeSeguridad_perfil" class="form-text text-danger d-none">La contrase√±a no es segura.Debe tener al menos 8 caracteres, incluir una may√∫scula, una min√∫scula, un n√∫mero y un caracter especial.</small>
                    </div>
                    <div class="mb-2">
                        <label>Confirmar Contrase√±a</label>
                        <input type="password" id="perfil_confirmar" class="form-control" required>
                        <small id="mensajeCoincidencia_perfil" class="form-text text-danger d-none"> Las contrase√±as no coinciden</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <script src="js/perfil.js"></script>
  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
  <script src="script.js"></script>
  <!-- JavaScript -->
  <script src="js/funcionesSistema.js"></script>
  <script src="js/ventas.js"></script>
  <script src="js/bd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <!-- MENU -->
  <script src="menu/bootstrap.bundle.min.js"></script>
  <script src="menu/scripts.js"></script>
  <!-- DATATABLES -->
  <script src="dt/jquery-3.7.1.js"></script>
  <script src="dt/datatables.min.js"></script>
  <script src="dt/jquery.dataTables.min.js"></script>
  <!-- DATATABLES Buttons extension -->
  <script src="dt/dataTables.buttons.min.js"></script>
  <script src="dt/buttons.print.min.js"></script>
  <script src="dt/buttons.html5.min.js"></script>
  <!-- DATATABLES JSZip y pdfmake para exportar -->
  <script src="dt/jszip.min.js"></script>
  <script src="dt/pdfmake.min.js"></script>
  <script src="dt/vfs_fonts.js"></script>
  <!-- DATATABLES Idioma Espa√±ol -->
  <script src="dt/es-ES.js"></script>
  <script>
    // control de seguridad al cargarse la p√°gina
    document.addEventListener("DOMContentLoaded", function () {
        const nombre = sessionStorage.getItem("nomUsuario");
        if (!nombre) {
        // Si no hay sesi√≥n, redirige al login
            window.location.href = "error.html";
        } else {
        // Mostrar el nombre del usuario si existe el elemento
            const spanUsuario = document.getElementById("usuario");
            if (spanUsuario) {
            spanUsuario.textContent = nombre;
            }
        }
    });
    // usuario actual
    const usuarioActual = {
        rol: sessionStorage.getItem("rolUsuario")
    }

    function mostrarTicketVenta(venta, recibido = 0, vuelto = 0) {
      let totalIva10 = 0, totalIva5 = 0, totalExentas = 0;

      let detalleHTML = venta.detalle.map(item => {
        const iva = item.iva;
        const subtotal = item.subtotal;
        if (iva === 10) totalIva10 += subtotal;
        else if (iva === 5) totalIva5 += subtotal;
        else totalExentas += subtotal;

        return `
          <tr>
            <td>${item.nombre_articulo}</td>
            <td>${iva}%</td>
            <td>${item.cantidad}</td>
            <td>${item.precioUnit}</td>
            <td>${item.subtotal}</td>
          </tr>
        `;
      }).join("");

      const html = `
        <div id="comprobanteVentaHTML" style="font-family: monospace; font-size: 13px;">
          <center>
            <h5>*** LIBRER√çA ROC√çO ***</h5>
            <p>RUC: 5130408-2<br>
            Avda. Pinedo y Dr. Royg Bernal<br>
            Cel: 0975-370735<br>
            CONCEPCI√ìN - PARAGUAY</p>
            <hr>
            <h6><strong>PRESUPUESTO</strong></h6>
          </center>
          <p><strong>N¬∞:</strong> ${venta.factura}</p>
          <p><strong>Fecha:</strong> ${venta.fecha}</p>
          <p><strong>Cliente:</strong> ${venta.cliente}</p>
          <p><strong>RUC/CI:</strong> ${venta.ruc}</p>
          <p><strong>Condici√≥n:</strong> ${venta.condicion}</p>
          <table class="table table-sm table-bordered">
            <thead>
              <tr><th>ARTICULO</th><th>IVA</th><th>CANT.</th><th>PRE.UNIT</th><th>SUBTOTAL</th></tr>
            </thead>
            <tbody>${detalleHTML}</tbody>
          </table>
          <hr>
          <p><strong>Total A PAGAR:</strong> Gs. ${venta.total}</p>
          <hr>
          <p><strong>Recibido:</strong> Gs. ${recibido}</p>
          <p><strong>Vuelto:</strong> Gs. ${vuelto}</p>
          <hr>
          <h6><strong>TOTAL POR CONCEPTOS</strong></h6>
          <hr>
          <p><strong>Exentas:</strong> Gs. ${totalExentas}</p>
          <p><strong>IVA 5%:</strong> Gs. ${totalIva5}</p>
          <p><strong>IVA 10%:</strong> Gs. ${totalIva10}</p>
        <hr>
        <h6><strong>LIQUIDACION IVA</strong></h6>
        <hr>
          <p><strong>IVA 5%:</strong> Gs. ${(totalIva5 / 21).toFixed(0)}</p>
          <p><strong>IVA 10%:</strong> Gs. ${(totalIva10 / 11).toFixed(0)}</p>
          <p><strong>Total IVA:</strong> Gs. ${((totalIva5 / 21) + (totalIva10 / 11)).toFixed(0)}</p>
          <center><strong>¬°Gracias por su preferencia!</strong></center>
        </div>
      `;
      document.getElementById("contenidoComprobanteVenta").innerHTML = html;
      const modal = new bootstrap.Modal(document.getElementById("modalComprobanteVenta"));
      modal.show();
    }
    function imprimirComprobanteVenta() {
      const contenido = document.getElementById("comprobanteVentaHTML").innerHTML;
      const ventana = window.open("", "", "width=400,height=600");
      ventana.document.write(`
        <html>
          <head>
            <title>Imprimir Comprobante</title>
          </head>
          <body style="font-family: monospace;">${contenido}</body>
        </html>
      `);
      ventana.document.close();
      ventana.focus();
      ventana.print();
    }
    function exportarPDFComprobante() {
      const element = document.getElementById("comprobanteVentaHTML");
      html2pdf().set({
        margin: 0.5,
        filename: 'comprobante_venta.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a5', orientation: 'portrait' }
      }).from(element).save();
    }     
    //botones para exportar a excel, pdf e imprimir
    tablaVentas = $('#tabla_ventas').DataTable({
      dom: 'Bfrtip',
      buttons: [
        {
          extend: 'excelHtml5',
          text: 'Exportar a Excel',
          title: 'Ventas'
        },
        {
        extend: 'pdfHtml5',
        text: 'Exportar a PDF',
        className: 'btn btn-danger',
        orientation: 'landscape', // opcional: horizontal
        pageSize: 'A4',
        title: 'Registro de Ventas',
        customize: function (doc) {
            // Encabezado personalizado (membrete, fecha)
            const now = new Date();
            const fecha = now.toLocaleDateString();
            const hora = now.toLocaleTimeString();

            // Agregar encabezado
            doc.content.splice(0, 0,
            {
                text: [
                { text: 'LIBRERIA ROCIO\n', fontSize: 14, bold: true },
                { text: 'Registro de Ventas\n', fontSize: 12 }
                ],
                alignment: 'center',
                margin: [0, 0, 0, 12]
            }
            );

            // Pie de p√°gina con n√∫mero de p√°gina
            doc.footer = function (currentPage, pageCount) {
            return {
                columns: [
                { text: `Fecha de exportaci√≥n: ${fecha} ${hora}`, alignment: 'left', margin: [40, 0] },
                { text: `P√°gina ${currentPage} de ${pageCount}`, alignment: 'right', margin: [0, 0, 40] }
                ],
                fontSize: 8
            };
            };

            // Ajustes opcionales de estilo
            doc.styles.tableHeader.alignment = 'center';
            doc.defaultStyle.fontSize = 10;
        }
        },
        {
          extend: 'print',
          text: 'Imprimir',
          title: 'Ventas'
        }
      ],
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
      }
    });
    // Funci√≥n que oculta elementos del men√∫ dependiendo del rol
    document.addEventListener("DOMContentLoaded", function () {
      const rol = sessionStorage.getItem("rolUsuario"); // Roles posibles: administrador, gerente, cajero, codificador
      const nombre = sessionStorage.getItem("nomUsuario");

      // Si no hay datos de sesi√≥n, redirigir al login
      if (!rol || !nombre) {
        alertify.error("Acceso denegado.");
        window.location.href = "login.html";
        return;
      }

      // Mostrar el nombre del usuario en el panel
      const spanUsuario = document.getElementById("usuario");
      if (spanUsuario) spanUsuario.textContent = nombre;

      // L√≥gica para ocultar secciones del men√∫ seg√∫n el rol
      switch (rol) {
        case "administrador":
          // Tiene acceso a todo, no se oculta nada
          break;
        case "gerente":
          ocultar(["menuUsuarios"]);
          break;
        case "cajero":
          ocultar(["menuMantenimiento", "menuCompras", "menuUsuarios"]);
          break;
        case "codificador":
          ocultar(["menuVentas", "menuCompras", "menuInformes", "menuUsuarios"]);
          break;
        default:
          alertify.error("Rol no v√°lido.");
          window.location.href = "login.html";
      }

      // Funci√≥n auxiliar para ocultar elementos por sus IDs
      function ocultar(ids) {
        ids.forEach(id => {
          const elem = document.getElementById(id);
          if (elem) elem.style.display = "none";
        });
      }

      // Generar y asignar autom√°ticamente un n√∫mero de factura
      document.getElementById("factura").value = generarNumeroFactura();

      function generarNumeroFactura() {
        const now = new Date();
        return "F" +
          now.getFullYear().toString().slice(-2) +
          (now.getMonth() + 1).toString().padStart(2, "0") +
          now.getDate().toString().padStart(2, "0") +
          "-" +
          Math.floor(Math.random() * 9000 + 1000); // Ejemplo: F250704-4567
      }
    });

    // FECHA AUTOM√ÅTICA AL CARGAR
    const hoy = new Date().toISOString().split("T")[0];
    document.getElementById("fecha").value = hoy;
    document.getElementById("efectivo").addEventListener("input", calcularCambio);
    document.getElementById("ruc").addEventListener("blur", buscarClientePorRuc);
    function buscarClientePorRuc() {
      const ruc = document.getElementById("ruc").value.trim();
      const clientes = JSON.parse(localStorage.getItem("clientes")) || [];
      const cliente = clientes.find(c => c.ruc === ruc);
      if (cliente) {
        document.getElementById("cliente").value = cliente.nombre;
        document.getElementById("direccion").value = cliente.direccion;
        alertify.success("Cliente encontrado");
      } else {
        document.getElementById("cliente").value = "VENTA AL P√öBLICO";
        document.getElementById("direccion").value = "";
        alertify.error("Cliente no encontrado");
      }
    }
    document.getElementById("producto").addEventListener("blur", buscarProductoPorCodigo);
    function buscarProductoPorCodigo() {
      const codigo = document.getElementById("producto").value.trim();
      const articulos = JSON.parse(localStorage.getItem("articulos")) || [];
      const articulo = articulos.find(a => a.codigo === codigo);

      if (articulo) {
        document.getElementById("descripcion").value = articulo.nombre_articulo;
        document.getElementById("precioUnit").value = articulo.precio;
        alertify.success("Producto encontrado");
      } else {
        document.getElementById("descripcion").value = "";
        document.getElementById("precioUnit").value = "";
        alertify.error("Producto no encontrado");
      }
    }
    // habilitar crear nuevos usuarios solo para adminsitradores
    document.addEventListener("DOMContentLoaded", function(){
      const btnCrear = document.getElementById("btnCrearCliente");
      if(btnCrear && !tienePermiso(usuarioActual, permisos.usuarios_crear)){
          btnCrear.style.display = "none"; // oculta si no tiene permiso
      }
    });

    let detalleVenta = [];
    // A√ëADIR PRODUCTO A LA TABLA
    function agregarProducto() {
      const producto = document.getElementById("producto").value;
      const nombre_articulo = document.getElementById("descripcion").value;
      const cantidad = parseInt(document.getElementById("cantidad").value);
      const precioUnit = parseInt(document.getElementById("precioUnit").value);
      const iva = 10;

      if (!producto || isNaN(cantidad) || isNaN(precioUnit)) {
          alertify.error("Completa los campos del producto");
          return;
      }

      const subtotal = cantidad * precioUnit;

      detalleVenta.push({
          codigo: producto,
          nombre_articulo,
          cantidad,
          precioUnit,
          iva,
          subtotal
      });

      mostrarDetalle();
      limpiarCamposProducto();
    }

    // MOSTRAR DETALLE EN LA TABLA
    function mostrarDetalle() {
      const tbody = document.querySelector("#tablaDetalle tbody");
      tbody.innerHTML = "";
      let total = 0;
      detalleVenta.forEach((item, index) => {
          total += item.subtotal;
          const fila = document.createElement("tr");
          fila.innerHTML = `
              <td>${item.codigo}</td>
              <td>${item.nombre_articulo}</td>
              <td>${item.cantidad}</td>
              <td>${item.precioUnit}</td>
              <td>${item.iva}%</td>
              <td>${item.subtotal}</td>
              <td><button class="btn btn-danger btn-sm" onclick="eliminarProducto(${index})">Eliminar</button></td>
          `;
          tbody.appendChild(fila);
      });
      document.getElementById("total").textContent = total;
      document.getElementById("modalTotal").value = total;
    }
    function mostrarFechaVencimiento() {
      const condicion = document.getElementById("condicionPago").value;
      const vencimiento = document.getElementById("grupoFechaVencimiento");
      vencimiento.style.display = condicion === "cr√©dito" ? "block" : "none";
    }
    // ELIMINAR PRODUCTO DE LA TABLA
    function eliminarProducto(index) {
      detalleVenta.splice(index, 1);
      mostrarDetalle();
    }
    // LIMPIAR CAMPOS DE PRODUCTO
    function limpiarCamposProducto() {
      document.getElementById("producto").value = "";
      document.getElementById("descripcion").value = "";
      document.getElementById("cantidad").value = "";
      document.getElementById("precioUnit").value = "";
    }
    // CALCULAR CAMBIO EN EL MODAL
    function calcularCambio() {
      const efectivo = parseInt(document.getElementById("efectivo").value) || 0;
      const total = parseInt(document.getElementById("modalTotal").value) || 0;
      const cambio = efectivo - total;
      document.getElementById("cambio").value = cambio >= 0 ? cambio : 0;
    }
    // REGISTRAR VENTA
    function generarIdUnico() {
      return Date.now() + Math.floor(Math.random() * 1000); // Ej: 1720206812520
    }
    function registrarVenta() {
      const cliente = document.getElementById("cliente").value.trim();
      const fechaVencimiento = document.getElementById("fechaVencimiento").value;
      const condicion = document.getElementById("condicionPago").value;

      if (detalleVenta.length === 0) {
          alertify.error("Debes agregar al menos un producto");
          return;
      }

      if (condicion === "cr√©dito") {
          const rol = sessionStorage.getItem("rolUsuario");

          if (!cliente || cliente.toUpperCase() === "VENTA AL P√öBLICO") {
              alertify.error("Selecciona un cliente v√°lido para cr√©dito");
              return;
          }

          if (!fechaVencimiento) {
              alertify.error("Debes establecer una fecha de vencimiento");
              return;
          }

          if (rol === "administrador") {
              guardarVenta("cr√©dito", fechaVencimiento);
          } else if (rol === "cajero") {
              const modal = new bootstrap.Modal(document.getElementById("modalAdmin"));
              modal.show();
          } else {
              alertify.error("Solo un administrador puede autorizar cr√©ditos");
          }

      } else {
          // ABRIR MODAL DE PAGO (SOLO PARA CONTADO)
          const modal = new bootstrap.Modal(document.getElementById("modalVenta"));
          modal.show();
          
      }
    }
    function verificarStockDisponible() {
      let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
      for (const item of detalleVenta) {
        const articulo = articulos.find(a => a.codigo === parseInt(item.codigo));
        if (!articulo) {
          alertify.error(`Art√≠culo no encontrado: c√≥digo ${item.codigo}`);
          return false;
        }
        if (articulo.stock <= 0) {
          alertify.error(`No hay stock disponible para: ${articulo.nombre_articulo}`);
          return false;
        }    
        if (item.cantidad > articulo.stock) {
          alertify.error(`Cantidad solicitada supera el stock para: ${articulo.nombre_articulo} (Stock: ${articulo.stock})`);
          return false;
        }
      }
      
      return true;
    }
    // RESTAR STOCK AL CONFIRMAR VENTA
    function restarStock() {
      let articulos = JSON.parse(localStorage.getItem("articulos")) || [];

      detalleVenta.forEach((item) => {
          let articulo = articulos.find(a => a.codigo === parseInt(item.codigo));
          if (articulo) {
              articulo.stock = (articulo.stock || 0) - item.cantidad;
              console.log(`Stock actualizado: ${articulo.nombre_articulo} ‚Üí ${articulo.stock}`);
          } else {
              console.warn(`Art√≠culo no encontrado: c√≥digo ${item.codigo}`);
          }
      });

      localStorage.setItem("articulos", JSON.stringify(articulos));
    }

    function guardarVenta(condicion, fechaVencimiento = null) {
      if (!verificarStockDisponible()) {
        return; // Detener la funci√≥n si no hay stock suficiente
      }
      const idVenta = generarIdUnico();
      const venta = {
          id: idVenta,
          cliente: document.getElementById("cliente").value.trim(),
          ruc: document.getElementById("ruc").value.trim() || "-",
          direccion: document.getElementById("direccion").value.trim() || "-",
          fecha: document.getElementById("fecha").value,
          factura: document.getElementById("factura").value,
          total: document.getElementById("modalTotal").value,
          condicion: condicion,
          estado: condicion === "cr√©dito" ? "pendiente" : "pagado",
          fechaVencimiento: condicion === "cr√©dito" ? fechaVencimiento : null,
          detalle: detalleVenta
      };
      let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
      ventas.push(venta);
      localStorage.setItem("ventas", JSON.stringify(ventas));
      if (condicion === "cr√©dito") {
        const credito = {
            id: idVenta,
            cliente: venta.cliente,
            ruc: venta.ruc,
            fecha: venta.fecha,
            factura: venta.factura,
            vencimiento: fechaVencimiento,
            total: parseFloat(venta.total),
            saldoPendiente: parseFloat(venta.total),
            estado: "pendiente",
            pagos: [],
            detalle: venta.detalle
        };
        let creditos = JSON.parse(localStorage.getItem("creditos")) || [];
        creditos.push(credito);
        localStorage.setItem("creditos", JSON.stringify(creditos));
      }
      restarStock();
      alertify.success("Venta registrada correctamente");
      mostrarTicketVenta(venta, document.getElementById("efectivo").value, document.getElementById("cambio").value);
      if (condicion === "contado") {
        const modal = bootstrap.Modal.getInstance(document.getElementById("modalVenta"));
        const efectivo = parseInt(document.getElementById("efectivo").value) || 0;
        const total = parseInt(document.getElementById("modalTotal").value) || 0;

        if (efectivo < total) {
            alertify.error("El efectivo recibido no puede ser menor al total de la venta");
            return;
        }
        if (modal) modal.hide();
      }
      limpiarFormulario();    
    }

    function verificarAdmin() {
        const usuario = document.getElementById("adminUsuario").value.trim();
        const clave = document.getElementById("adminPassword").value.trim();

        const usuarios = JSON.parse(localStorage.getItem("usuarios")) || [];
        const admin = usuarios.find(u => u.usuario === usuario && u.clave === clave && u.rol === "administrador");

        if (admin) {
            alertify.success("Autenticaci√≥n exitosa");
            bootstrap.Modal.getInstance(document.getElementById("modalAdmin")).hide();

            const fechaVencimiento = document.getElementById("fechaVencimiento").value;
            guardarVenta("cr√©dito", fechaVencimiento);
        } else {
            alertify.error("Credenciales incorrectas o no es administrador");
        }
    }

    function limpiarFormulario() {
      detalleVenta = [];
      document.getElementById("formCompras").reset();
      document.getElementById("total").textContent = "";
      document.getElementById("modalTotal").value = "";
      document.getElementById("efectivo").value = "";
      document.getElementById("cambio").value = "";
      mostrarDetalle();
    }

    // F2: MOSTRAR MODAL CLIENTES
    document.addEventListener("keydown", function (e) {
        if (e.key === "F2") {
            e.preventDefault();
            mostrarModalClientes();
        }
    });
    // F3: MOSTRAR MODAL ART√çCULOS
    document.addEventListener("keydown", function (e) {
        if (e.key === "F3") {
            e.preventDefault();
            mostrarModalArticulos();
        }
    });

    function mostrarModalClientes() {
        const modal = new bootstrap.Modal(document.getElementById("modalClientes"));
      const tbody = document.querySelector("#tablaClientes tbody");
      tbody.innerHTML = "";
      const clientes = JSON.parse(localStorage.getItem("clientes")) || [];
      clientes.forEach((c) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${c.nombre}</td>
          <td>${c.ruc}</td>
          <td>${c.direccion}</td>
          <td><button class="btn btn-sm btn-primary" onclick="seleccionarCliente('${c.nombre}', '${c.ruc}', '${c.direccion}')">Seleccionar</button></td>
        `;
        tbody.appendChild(fila);
      });
      modal.show();
    }

    function mostrarModalArticulos() {
      const modal = new bootstrap.Modal(document.getElementById("modalArticulos"));
      const tbody = document.querySelector("#tablaArticulosModal tbody");
      tbody.innerHTML = "";

      const articulos = JSON.parse(localStorage.getItem("articulos")) || [];

      articulos.forEach((a) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${a.codigo}</td>
          <td>${a.nombre_articulo}</td>
          <td>${a.precio}</td>
          <td>${a.iva}%</td>
          <td><button class="btn btn-sm btn-primary" onclick="seleccionarArticulo('${a.codigo}', '${a.nombre_articulo}', '${a.precio}')">Seleccionar</button></td>
        `;
        tbody.appendChild(fila);
      });

      modal.show();
    }

    function seleccionarCliente(nombre, ruc, direccion) {
        document.getElementById("cliente").value = nombre;
        document.getElementById("ruc").value = ruc;
        document.getElementById("direccion").value = direccion;
        bootstrap.Modal.getInstance(document.getElementById("modalClientes")).hide();
        alertify.success("Cliente seleccionado");
    }

    function seleccionarArticulo(codigo, nombre, precio) {
        document.getElementById("producto").value = codigo;
        document.getElementById("descripcion").value = nombre;
        document.getElementById("precioUnit").value = precio;
        document.getElementById("cantidad").focus();
        bootstrap.Modal.getInstance(document.getElementById("modalArticulos")).hide();
        alertify.success("Art√≠culo seleccionado");
    }

     //funcion que oculta elementos del menu dependiendo del rol
        document.addEventListener("DOMContentLoaded", function () {
            const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!rol || !nombre) {
                alertify.error("Acceso denegado.");
                window.location.href = "login.html";
                return;
            }
            // Mostrar el nombre en el panel
            const spanUsuario = document.getElementById("usuario");
            if (spanUsuario) spanUsuario.textContent = nombre;
            
            // Ocultar men√∫s seg√∫n el rol
            switch (rol) {
            case "administrador":
                // ve todo
                break;
            case "gerente":
                ocultar(["menuMantenimiento", "menuCompras", "menuStock", "menuVentas"]);
                break;
            case "cajero":
                ocultar(["menuMantenimiento", "menuCompras", "menuStock", "opcCobro", "opcCredito", "opcListadoVentas", "menuInformes"]);
                break;
            case "codificador":
                ocultar(["opcUsuario", "opcClientes", "menuVentas", "opcPagos", "opcListado", "menuStock", "menuInformes"]);
                break;
            default:
                alertify.error("Rol no v√°lido.");
                window.location.href = "login.html";
            }
            // Funci√≥n para ocultar elementos por ID
            function ocultar(ids) {
                ids.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.style.display = "none";
                });
            }
        });
        // reglas para el perfil
        document.addEventListener("DOMContentLoaded", function () {
            const reglas = {
                r1: c => c.length >= 8,
                r2: c => /[A-Z]/.test(c),
                r3: c => /[a-z]/.test(c),
                r4: c => /\d/.test(c),
                r5: c => /[@#$%^&+=!¬°¬ø?*()\-_"':;.,<>~`|{}\[\]\\]/.test(c),
            };
            function mostrarSeguridad(inputId, mensajeId) {
                const input = document.getElementById(inputId);
                const mensaje = document.getElementById(mensajeId);
                if (!input || !mensaje) return;
                input.addEventListener("input", () => {
                    const contra = input.value;
                    const cumple = Object.values(reglas).every(fn => fn(contra));
                    if (contra === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    mensaje.classList.remove("d-none");
                    if (cumple) {
                        mensaje.textContent = "üü¢ Contrase√±a segura";
                        mensaje.classList.remove("text-danger");
                        mensaje.classList.add("text-success");
                    } else {
                        mensaje.textContent = "La contrase√±a no es segura. Debe tener al menos 8 caracteres, incluir una may√∫scula, una min√∫scula, un n√∫mero y un caracter especial.";
                        mensaje.classList.remove("text-success");
                        mensaje.classList.add("text-danger");
                    }
                });
            }
            // Validaci√≥n al enviar formulario
            [
                { formId: "formPerfilUsuario", passId: "perfil_contrasena", confId: "perfil_confirmar" },
            ].forEach(({ formId, passId, confId }) => {
                const form = document.getElementById(formId);
                form.addEventListener("submit", function (e) {
                const contra = document.getElementById(passId).value;
                const confContra = document.getElementById(confId).value;
                const cumple = Object.values(reglas).every(fn => fn(contra));

                if (!cumple) {
                    e.preventDefault();
                    alertify.error("La contrase√±a no es segura.");
                } else if (contra !== confContra) {
                    e.preventDefault();
                    alertify.warning("Las contrase√±as no coinciden.");
                }
                });
            });
            // funci√≥n para verificar coincidencia de contrase√±as
            function verificarCoincidencia(passId, confId, mensajeId) {
                const pass = document.getElementById(passId);
                const conf = document.getElementById(confId);
                const mensaje = document.getElementById(mensajeId);
                function checkMatch() {
                    if (conf.value === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    if (pass.value === conf.value) {
                        mensaje.classList.add("d-none");
                    } else {
                        mensaje.textContent = "Las contrase√±as no coinciden";
                        mensaje.classList.remove("d-none");
                    }
                }
                pass.addEventListener("input", checkMatch);
                conf.addEventListener("input", checkMatch);
            }
            mostrarSeguridad("perfil_contrasena", "mensajeSeguridad_perfil");
            verificarCoincidencia("perfil_contrasena", "perfil_confirmar", "mensajeCoincidencia_perfil");
        });
  </script>
</body>
</html>
