<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historial de Pagos</title>
    <!-- Icono -->
    <link rel="icon" href="img/logo16px.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
    <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li id="opcArticulos"><a class="dropdown-item" href="articulos.html">Art√≠culos</a></li>
                                <li id="opcProveedores"><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li id="opcMarcas"><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li id="opcCategorias"><a class="dropdown-item" href="categorias.html">Categor√≠as</a></li>
                                <li id="opcClientes"><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                                <li id="opcUsuario"><a class="dropdown-item" href="usuario.html">Usuarios</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="compra.html">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="compras_hechas.html">Listado de compras</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li id="opcPagos"><a class="dropdown-item" href="pago_proveedores.html">Pago a Proveedores</a></li>
                                <li id="opcListado"><a class="dropdown-item" href="pagos_hechos.html">Listado de pagos</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuStock">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Stock
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ajuste_stock.html">Ajuste de Stock</a></li>
                                <li><a class="dropdown-item" href="ajustes_hechos.html">Listado de ajustes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="Registrodeventas.html">Registro de ventas</a></li>
                                <li id="opcListadoVentas"><a class="dropdown-item" href="ventas_realizadas.html">Listado de ventas</a></li>
                                <li id="opcCredito"><a class="dropdown-item" href="creditos_clientes.html">Cr√©ditos con clientes</a></li>
                                <li id="opcCobro"><a class="dropdown-item" href="historial_de pagos.html">Cobro de cr√©ditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="informe_venta.html">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="informe_credito.html">Informes de cr√©ditos con clientes </a></li>
                                <li><a class="dropdown-item" href="informe_cobro_credito.html">Informes de cobr√≥ de cr√©ditos</a></li>
                                <li><a class="dropdown-item" href="informeCompra.html">Informes de compras</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!" onclick="abrirPerfil()">Mi Perfil</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesi√≥n</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>    
    <!-- Contenedor Principal -->
     <div class="card mb-4">
        <div class="card-header bg-secondary text-white fw-bold">
            Historial de Pagos
        </div>
        <!-- Filtrar PDF por fecha -->
        <div class="mb-3 d-flex gap-3 align-items-end">
            <div>
                <label for="fechaInicio" class="form-label">Desde:</label>
                <input type="date" id="fechaInicio" class="form-control">
            </div>
            <div>
                <label for="fechaFin" class="form-label">Hasta:</label>
                <input type="date" id="fechaFin" class="form-control">
            </div>
            <button id="btnFiltrar" class="btn btn-primary">Filtrar</button>
        </div>
  <!-- Tabla -->
    <div class="table-responsive">
        <table class="table table-bordered" id="tablaCreditos">
            <thead>
                <tr>
                <th>Cliente</th>
                <th>RUC</th>
                <th>Factura</th>
                <th>Fecha</th>
                <th>Total</th>
                <th>Saldo</th>
                <th>Estado</th>
                <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>

   <!-- Modal para ver pagos realizados -->
<div class="modal fade" id="modalPagos" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Pagos realizados</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="contenidoPagos">
        <p><strong>Cliente:</strong> <span id="clienteNombreTicket"></span></p>
        <ul id="listaPagos" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-secondary" onclick="imprimirTicket()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-outline-danger" onclick="descargarPDF()">üìÑ PDF</button>
      </div>
    </div>
  </div>
</div>

<!--Modal para editar el perfil del usuario -->
    <div class="modal fade" id="modalPerfilUsuario" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formPerfilUsuario" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Editar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="perfil_id">
                    <div class="mb-2">
                        <label>Nombre del Usuario</label>
                        <input type="text" id="perfil_nombre" class="form-control" readonly>
                    </div>
                    <div class="mb-2">
                        <label>Usuario</label>
                        <input type="text" id="perfil_usuario" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Contrase√±a</label>
                        <input type="password" id="perfil_contrasena" class="form-control" required>
                        <small id="mensajeSeguridad_perfil" class="form-text text-danger d-none">La contrase√±a no es segura.Debe tener al menos 8 caracteres, incluir una may√∫scula, una min√∫scula, un n√∫mero y un caracter especial.</small>
                    </div>
                    <div class="mb-2">
                        <label>Confirmar Contrase√±a</label>
                        <input type="password" id="perfil_confirmar" class="form-control" required>
                        <small id="mensajeCoincidencia_perfil" class="form-text text-danger d-none"> Las contrase√±as no coinciden</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>
    <script src="js/perfil.js"></script>

<!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.13.1/build/alertify.min.js"></script>
  <script src="script.js"></script>

 <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/ventas.js"></script>
    <script src="js/bd.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Espa√±ol -->
    <script src="dt/es-ES.js"></script>

    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
// control de seguridad al cargarse la p√°gina
       document.addEventListener("DOMContentLoaded", function () {
        const nombre = sessionStorage.getItem("nomUsuario");

        if (!nombre) {
        // Si no hay sesi√≥n, redirige al login
            window.location.href = "error.html";
        } else {
        // Mostrar el nombre del usuario si existe el elemento
            const spanUsuario = document.getElementById("usuario");
            if (spanUsuario) {
            spanUsuario.textContent = nombre;
            }
        }
    });
    
    //funcion que oculta elementos del menu dependiendo del rol
    document.addEventListener("DOMContentLoaded", function () {
    const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
    const nombre = sessionStorage.getItem("nomUsuario");

    if (!rol || !nombre) {
      alertify.error("Acceso denegado.");
      window.location.href = "login.html";
      return;
    }

    // Mostrar el nombre en el panel
    const spanUsuario = document.getElementById("usuario");
    if (spanUsuario) spanUsuario.textContent = nombre;

    
    // Ocultar men√∫s seg√∫n el rol
    switch (rol) {
      case "administrador":
        // ve todo
        break;
      case "gerente":
        ocultar(["menuUsuarios"]);
        break;
      case "cajero":
        ocultar(["menuMantenimiento", "menuCompras", "menuUsuarios"]);
        break;
      case "codificador":
        ocultar(["menuVentas", "menuCompras", "menuInformes", "menuUsuarios"]);
        break;
      default:
        alertify.error("Rol no v√°lido.");
        window.location.href = "login.html";
    }

    // Funci√≥n para ocultar elementos por ID
    function ocultar(ids) {
      ids.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.style.display = "none";
      });
    }
  });
        // habilitar crear nuevos usuarios solo para adminsitradores
        document.addEventListener("DOMContentLoaded", function(){
            const btnCrear = document.getElementById("btnCrearCliente");
            if(btnCrear && !tienePermiso(usuarioActual, permisos.usuarios_crear)){
                btnCrear.style.display = "none"; // oculta si no tiene permiso
            }
        });


    document.addEventListener("DOMContentLoaded", () => {
    const creditos = JSON.parse(localStorage.getItem("creditos")) || [];
    const tbody = document.querySelector("#tablaCreditos tbody");
    tbody.innerHTML = "";

    creditos.forEach((credito, index) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
        <td>${credito.cliente}</td>
        <td>${credito.ruc}</td>
        <td>${credito.factura}</td>
        <td>${credito.fecha}</td>
        <td>Gs. ${credito.total}</td>
        <td>Gs. ${credito.saldoPendiente}</td>
        <td>${credito.estado}</td>
        <td>
            <button class="btn btn-sm btn-primary" onclick="verPagos(${index})">
            Ver pagos
            </button>
        </td>
        `;
        tbody.appendChild(tr);
    });
    });
    function verPagos(index) {
    const creditos = JSON.parse(localStorage.getItem("creditos")) || [];
    const credito = creditos[index];
    const lista = document.getElementById("listaPagos");
    lista.innerHTML = "";

    // Mostramos nombre del cliente en el modal
    document.getElementById("clienteNombreTicket").textContent = credito.cliente;

    if (!credito.pagos || credito.pagos.length === 0) {
        lista.innerHTML = `<li class="list-group-item">No hay pagos registrados</li>`;
    } else {
        credito.pagos.forEach((pago, i) => {
        const li = document.createElement("li");
        li.classList.add("list-group-item");
        li.textContent = `#${i + 1} - Fecha: ${pago.fecha} - Monto: Gs. ${pago.monto} - Obs: ${pago.observacion || '-'}`;
        lista.appendChild(li);
        });
    }

    const modal = new bootstrap.Modal(document.getElementById("modalPagos"));
    modal.show();
    }

   function imprimirTicket() {
    const nombre = document.getElementById("clienteNombreTicket").textContent;
    const pagos = Array.from(document.querySelectorAll("#listaPagos li"))
        .map(li => li.textContent)
        .join("<br>");

    const ticketHTML = `
<html>
  <head>
    <title>Ticket de Pago</title>
    <style>
      body { font-family: monospace; padding: 20px; width: 300px; }
      h2, h4 { text-align: center; margin: 0; }
      hr { border: 1px dashed #000; margin: 10px 0; }
      .datos { font-size: 14px; margin-bottom: 10px; }
      .pagos { font-size: 13px; white-space: pre-line; }
      .footer { text-align: center; margin-top: 10px; font-size: 12px; }
    </style>
  </head>
  <body>
    <h2>LIBRER√çA ROC√çO</h2>
    <div class="datos">
      RUC: 5130408-2<br>
      Avda. Pinedo y Dr. Royg Bernal<br>
      Cel: 0975-370735<br>
      CONCEPCI√ìN - PARAGUAY
    </div>
    <hr>
    <h4>TICKET DE PAGO</h4>
    <p><strong>Cliente:</strong> ${nombre}</p>
    <div class="pagos">${pagos}</div>
    <hr>
    <div class="footer">Gracias por su pago.</div>
    <script>window.print();<\/script>
  </body>
</html>
`;

const ventana = window.open("", "_blank");
ventana.document.write(ticketHTML);
ventana.document.close();
}
function descargarPDF() {
    const nombre = document.getElementById("clienteNombreTicket").textContent;
    const pagos = Array.from(document.querySelectorAll("#listaPagos li"))
        .map((li, i) => `#${i + 1} - ${li.textContent}`);

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(14);
    doc.text("LIBRER√çA ROC√çO", 70, 10);
    doc.setFontSize(10);
    doc.text("RUC: 5130408-2", 10, 20);
    doc.text("Avda. Pinedo y Dr. Royg Bernal", 10, 25);
    doc.text("Cel: 0975-370735", 10, 30);
    doc.text("CONCEPCI√ìN - PARAGUAY", 10, 35);
    doc.line(10, 40, 200, 40); // l√≠nea horizontal

    doc.setFontSize(12);
    doc.text("TICKET DE PAGO", 80, 50);
    doc.text(`Cliente: ${nombre}`, 10, 60);

    pagos.forEach((pago, i) => {
        doc.text(pago, 10, 70 + i * 10);
    });

    doc.text("Gracias por su pago.", 10, 80 + pagos.length * 10);

    doc.save("ticket_pago.pdf");
}
    //funcion que oculta elementos del menu dependiendo del rol
        document.addEventListener("DOMContentLoaded", function () {
            const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!rol || !nombre) {
                alertify.error("Acceso denegado.");
                window.location.href = "login.html";
                return;
            }
            // Mostrar el nombre en el panel
            const spanUsuario = document.getElementById("usuario");
            if (spanUsuario) spanUsuario.textContent = nombre;
            
            // Ocultar men√∫s seg√∫n el rol
            switch (rol) {
                case "administrador":
                    // ve todo
                    break;
                case "gerente":
                    ocultar(["menuUsuarios"]);
                    break;
                case "cajero":
                    ocultar(["menuMantenimiento", "menuCompras", "menuUsuarios"]);
                    break;
                case "codificador":
                    ocultar(["menuVentas", "menuCompras", "menuInformes", "menuUsuarios"]);
                    break;
                default:
                    alertify.error("Rol no v√°lido.");
                    window.location.href = "login.html";
            }
            // Funci√≥n para ocultar elementos por ID
            function ocultar(ids) {
                ids.forEach(id => {
                    const elem = document.getElementById(id);
                    if (elem) elem.style.display = "none";
                });
            }
        });
        // reglas para el perfil
        document.addEventListener("DOMContentLoaded", function () {
            const reglas = {
                r1: c => c.length >= 8,
                r2: c => /[A-Z]/.test(c),
                r3: c => /[a-z]/.test(c),
                r4: c => /\d/.test(c),
                r5: c => /[@#$%^&+=!¬°¬ø?*()\-_"':;.,<>~`|{}\[\]\\]/.test(c),
            };
            function mostrarSeguridad(inputId, mensajeId) {
                const input = document.getElementById(inputId);
                const mensaje = document.getElementById(mensajeId);
                if (!input || !mensaje) return;
                input.addEventListener("input", () => {
                    const contra = input.value;
                    const cumple = Object.values(reglas).every(fn => fn(contra));
                    if (contra === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    mensaje.classList.remove("d-none");
                    if (cumple) {
                        mensaje.textContent = "üü¢ Contrase√±a segura";
                        mensaje.classList.remove("text-danger");
                        mensaje.classList.add("text-success");
                    } else {
                        mensaje.textContent = "La contrase√±a no es segura. Debe tener al menos 8 caracteres, incluir una may√∫scula, una min√∫scula, un n√∫mero y un caracter especial.";
                        mensaje.classList.remove("text-success");
                        mensaje.classList.add("text-danger");
                    }
                });
            }
            // Validaci√≥n al enviar formulario
            [
                { formId: "formPerfilUsuario", passId: "perfil_contrasena", confId: "perfil_confirmar" },
            ].forEach(({ formId, passId, confId }) => {
                const form = document.getElementById(formId);
                form.addEventListener("submit", function (e) {
                const contra = document.getElementById(passId).value;
                const confContra = document.getElementById(confId).value;
                const cumple = Object.values(reglas).every(fn => fn(contra));

                if (!cumple) {
                    e.preventDefault();
                    alertify.error("La contrase√±a no es segura.");
                } else if (contra !== confContra) {
                    e.preventDefault();
                    alertify.warning("Las contrase√±as no coinciden.");
                }
                });
            });
            // funci√≥n para verificar coincidencia de contrase√±as
            function verificarCoincidencia(passId, confId, mensajeId) {
                const pass = document.getElementById(passId);
                const conf = document.getElementById(confId);
                const mensaje = document.getElementById(mensajeId);
                function checkMatch() {
                    if (conf.value === "") {
                        mensaje.classList.add("d-none");
                        return;
                    }
                    if (pass.value === conf.value) {
                        mensaje.classList.add("d-none");
                    } else {
                        mensaje.textContent = "Las contrase√±as no coinciden";
                        mensaje.classList.remove("d-none");
                    }
                }
                pass.addEventListener("input", checkMatch);
                conf.addEventListener("input", checkMatch);
            }
            mostrarSeguridad("perfil_contrasena", "mensajeSeguridad_perfil");
            verificarCoincidencia("perfil_contrasena", "perfil_confirmar", "mensajeCoincidencia_perfil");
        });
</script>
</body>
</html>