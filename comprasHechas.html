<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Compras</title>
    <!-- Icono -->
    <link rel="icon" href="img/user128.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- ESTILOS DEL MENU -->
    <link rel="stylesheet" href="menu/styles.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
    <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li><a class="dropdown-item" href="categorias.html">Clasificaciones</a></li>
                                <li><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="#">Créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ventas.html">Registro de ventas</a></li>
                                <li><a class="dropdown-item" href="credito_Cliente.html">Créditos con clientes</a></li>
                                <li><a class="dropdown-item" href="#">Cobró de creditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="#">Informes de Cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="#">Informes de compras</a></li>
                                <li><a class="dropdown-item" href="#">Informes de créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item" id="menuUsuarios"></li>
                            <a class="nav-link" href="usuario.html">Usuarios</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Configuraciones</a></li>
                            <li><a class="dropdown-item" href="#!">Actividad</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!--  -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white fw-bold">
            Listado de Compras
        </div>
        <div class="card-body">
            <table id="tablaCompras" class="table table-striped table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Proveedor</th>
                        <th>Fecha</th>
                        <th>N° Factura</th>
                        <th>Condición de pago</th>
                        <th>Número de artículos</th>
                        <th>Total</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Detalle de Compra -->
    <div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalDetalleLabel">Detalle de Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p id="cabeceraCompra" class="fw-bold"></p>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalleTablaBody"></tbody>
                    </table>
                    <div class="text-end fw-bold">
                        Total: <span id="totalCompra"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-end gap-2">
        <a href="compra.html" class="btn btn-info">
            <i class="bi bi-shop"></i> Volver al Registro de Compras
        </a>
    </div>
    <div>
        <footer class="py-2 bg-white mt-auto border-top">
            <div class="container-fluid px-4">
                <div class="d-flex align-items-center justify-content-between small text-muted">
                    <div>&copy; Librería Rocio 2025</div>
                </div>
            </div>
        </footer>
    </div>
    <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/auth/permisos.js"></script>
    <script src="js/bd.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>

    <script>
        // control de seguridad al cargarse la página
        document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "error.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });
        let compras = JSON.parse(localStorage.getItem("compras")) || [];
        const tbody = document.querySelector("#tablaCompras tbody");
        compras.forEach((compra, index) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${compra.idCompra}</td>
            <td>${compra.proveedor}</td>
            <td>${compra.fecha}</td>
            <td>${compra.numFactura}</td>
            <td>${compra.condicion}</td>
            <td>${compra.detalle.reduce((sum, item) => sum + item.cantidad, 0)}</td>
            <td>${compra.total}</td>
            <td>${compra.estado || 'activo'}</td>
            <td>
                ${
                    compra.estado === "anulado"
                    ? '<span class="badge bg-secondary">Anulado</span>'
                    :` 
                    <button class="btn btn-info btn-sm" onclick="verDetalle(${index})">Ver detalle</button>
                    <button class="btn btn-danger btn-sm" onclick="anularCompra(${index})">Anular</button>
                    `
                }
            </td>
        `;
        tbody.appendChild(fila);
        });
        // funcion para ver detalle
        function verDetalle(index){
            const compra = compras[index];
            // cabecera
            const cabecera = `Compra de ${compra.proveedor} (RUC: ${compra.ruc})<br>Fecha: ${compra.fecha} | Factura: ${compra.numFactura}`;
            document.getElementById("cabeceraCompra").innerHTML = cabecera;
            // detalle en tabla
            const tbody = document.getElementById("detalleTablaBody");
            tbody.innerHTML = "";
            compra.detalle.forEach(item => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${item.descripcion}</td>
                    <td class="text-end">${item.cantidad}</td>
                    <td class="text-end">${item.precioUnitario}</td>
                    <td class="text-end">${item.subtotal}</td>
                    `;
                tbody.appendChild(fila);
            });
            document.getElementById("totalCompra").textContent = compra.total;
            // mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById("modalDetalleCompra"));
            modal.show();
        }
        function anularCompra(index) {
    alertify.confirm("Anular compra", "¿Estás seguro de anular la compra?",
        function(){
            compras[index].estado = "anulado";

            // Ajustar el stock
            let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            compras[index].detalle.forEach(item => {
                const art = articulos.find(a => a.codigo == item.codBarra); // mejor comparación flexible
                if(art){
                    art.stock -= item.cantidad;
                }
            });
            localStorage.setItem("articulos", JSON.stringify(articulos));
            localStorage.setItem("compras", JSON.stringify(compras));

            // Actualizar la tabla visualmente
            const fila = document.querySelectorAll("#tablaCompras tbody tr")[index];
            fila.cells[7].textContent = "anulado";
            fila.cells[8].innerHTML = `<span class="badge bg-secondary">Anulado</span>`;

            alertify.success("Compra anulada correctamente");
        },
        function(){
            alertify.message("Anulación cancelada");
        }
    );
}

        function anularCompra(index) {
            alertify.confirm("Anular compra", "¿Estás seguro de anular la compra?",
                function(){
                    compras[index].estado = "anulado";
                    localStorage.setItem("compras", JSON.stringify(compras));

                    // Actualizar fila directamente en la tabla
                    const fila = document.querySelectorAll("#tablaCompras tbody tr")[index];
                    fila.cells[7].textContent = "anulado"; // Estado
                    fila.cells[8].innerHTML = `<span class="badge bg-secondary">Anulado</span>`; // Acciones

                    alertify.success("Compra anulada correctamente");
                },
                function(){
                    alertify.message("Anulación cancelada");
                }
            );
            
            let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
            compras[index].detalle.forEach(item => {
                const art = articulos.find(a => a.codigo === item.codBarra);
                if(art){
                    art.stock -= item.cantidad;
                }
            });
            localStorage.setItem("articulos", JSON.stringify(articulos));
        }

        //botones para exportar a excel, pdf e imprimir
        tablaCompras = $('#tablaCompras').DataTable({
        dom: 'Bfrtip',
        buttons: [
            {
            extend: 'excelHtml5',
            text: 'Exportar a Excel',
            title: 'Compras'
            },
            {
            extend: 'pdfHtml5',
            exportOptions : {
                columns: [1,2,3,4,5,6,7]
            },
            text: 'Exportar a PDF',
            className: 'btn btn-danger',
            orientation: 'vertical', // opcional: horizontal
            pageSize: 'A4',
            title: 'Registro de Compras',
            customize: function (doc) {
                // Encabezado personalizado (membrete, fecha)
                const now = new Date();
                const fecha = now.toLocaleDateString();
                const hora = now.toLocaleTimeString();

                // Agregar encabezado
                doc.content.splice(0, 0,
                {
                    text: [
                    { text: 'LIBRERIA ROCIO\n', fontSize: 14, bold: true },
                    { text: 'Registro de Compras\n', fontSize: 12 }
                    ],
                    alignment: 'center',
                    margin: [0, 0, 0, 12]
                }
                );

                // Pie de página con número de página
                doc.footer = function (currentPage, pageCount) {
                return {
                    columns: [
                    { text: `Fecha de exportación: ${fecha} ${hora}`, alignment: 'left', margin: [40, 0] },
                    { text: `Página ${currentPage} de ${pageCount}`, alignment: 'right', margin: [0, 0, 40] }
                    ],
                    fontSize: 8
                };
                };

                // Ajustes opcionales de estilo
                doc.styles.tableHeader.alignment = 'center';
                doc.defaultStyle.fontSize = 10;
            }
            },
            {
            extend: 'print',
            text: 'Imprimir',
            title: 'Compras'
            }
        ],
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
        }
        });
    </script>
</body>
</html>
