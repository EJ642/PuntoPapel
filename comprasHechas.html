<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listado de Compras</title>
    <!-- Icono -->
    <link rel="icon" href="img/user128.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- ESTILOS DEL MENU -->
    <link rel="stylesheet" href="menu/styles.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white fw-bold">
            Listado de Compras
        </div>
        <div class="card-body">
            <table id="tablaCompras" class="table table-striped table-hover table-bordered">
                <thead class="table-light">
                    <tr>
                    <th>ID</th>
                    <th>Proveedor</th>
                    <th>Fecha</th>
                    <th>N° Factura</th>
                    <th>Condición de pago</th>
                    <th>Número de artículos</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Modal Detalle de Compra -->
    <div class="modal fade" id="modalDetalleCompra" tabindex="-1" aria-labelledby="modalDetalleLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalDetalleLabel">Detalle de Compra</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p id="cabeceraCompra" class="fw-bold"></p>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr>
                            <th>Descripción</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="detalleTablaBody"></tbody>
                    </table>
                    <div class="text-end fw-bold">
                        Total: <span id="totalCompra"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-end gap-2">
        <a href="compra.html" class="btn btn-secondary">
            <i class="bi bi-square-fill"></i> Volver al Registro de Compras
        </a>
    </div>
    <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/auth/permisos.js"></script>
    <script src="js/bd.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>

    <script>
        // control de seguridad al cargarse la página
        /*document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "error.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });*/
        let compras = JSON.parse(localStorage.getItem("compras")) || [];
        const tbody = document.querySelector("#tablaCompras tbody");
        compras.forEach((compra, index) => {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>${compra.idCompra}</td>
            <td>${compra.proveedor}</td>
            <td>${compra.fecha}</td>
            <td>${compra.numFactura}</td>
            <td>${compra.condicion}</td>
            <td>${compra.detalle.reduce((sum, item) => sum + item.cantidad, 0)}</td>
            <td>${compra.total}</td>
            <td>${compra.estado || 'activo'}</td>
            <td>
            <button class="btn btn-info btn-sm" onclick="verDetalle(${index})">Ver detalle</button>
            <button class="btn btn-danger btn-sm" onclick="anularCompra(${index})">Anular</button>
            </td>
        `;
        tbody.appendChild(fila);
        });
        // funcion para ver detalle
        function verDetalle(index){
            const compra = compras[index];
            // cabecera
            const cabecera = `Compra de ${compra.proveedor} (RUC: ${compra.ruc})<br>Fecha: ${compra.fecha} | Factura: ${compra.numFactura}`;
            document.getElementById("cabeceraCompra").innerHTML = cabecera;
            // detalle en tabla
            const tbody = document.getElementById("detalleTablaBody");
            tbody.innerHTML = "";
            compra.detalle.forEach(item => {
                const fila = document.createElement("tr");
                fila.innerHTML = `
                    <td>${item.descripcion}</td>
                    <td class="text-end">${item.cantidad}</td>
                    <td class="text-end">${item.precioUnitario}</td>
                    <td class="text-end">${item.subtotal}</td>
                    `;
                tbody.appendChild(fila);
            });
            document.getElementById("totalCompra").textContent = compra.total;
            // mostrar el modal
            const modal = new bootstrap.Modal(document.getElementById("modalDetalleCompra"));
            modal.show();
        }
        function anularCompra(index) {
            alertify.confirm("Anular compra", "¿Estás seguro de anular la compra?",
                function(){
                    compras[index].estado = "anulado";
                    localStorage.setItem("compras", JSON.stringify(compras));

                    // Actualizar fila directamente en la tabla
                    const fila = document.querySelectorAll("#tablaCompras tbody tr")[index];
                    fila.cells[7].textContent = "anulado"; // Estado
                    fila.cells[8].innerHTML = `<span class="badge bg-secondary">Anulado</span>`; // Acciones

                    alertify.success("Compra anulada correctamente");
                },
                function(){
                    alertify.message("Anulación cancelada");
                }
            );
        }

        $(document).ready(function() {
        $('#tablaCompras').DataTable({
            dom: 'Bfrtip',
            buttons: [
            'copy', 'excel', 'pdf', 'print'
            ],
            language: {
            url: 'dt/es-ES.js'
            }
        });
        });
    </script>
</body>
</html>
