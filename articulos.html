<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Punto Papel: Artículos</title>
    <!-- Icono -->
    <link rel="icon" href="img/logo.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- JS -->
    <script src="js/permisos.js"></script>
    <script src="js/bd.js"></script>
    <!-- Bootstrap -->
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- DataTables -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <!-- Estilos personalizados -->
    <style>
        .text-right {
            text-align: right !important;
        }
        .dt-body-right {
            text-align: right;
        }
    </style>
</head>
<body>
   <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li><a class="dropdown-item" href="clasificaciones.html">Clasificaciones</a></li>
                                <li><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="#">Créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ventas.html">Registro de ventas</a></li>
                                <li><a class="dropdown-item" href="credito_Cliente.html">Créditos con clientes</a></li>
                                <li><a class="dropdown-item" href="#">Cobró de creditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="#">Informes de Cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="#">Informes de compras</a></li>
                                <li><a class="dropdown-item" href="#">Informes de créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item" id="menuUsuarios"></li>
                            <a class="nav-link" href="usuario.html">Usuarios</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Configuraciones</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- Contenido principal -->
    <div class="cont-principal">
        <main>
            <div class="container-fluid px-4">
                <h1 class="mt-2">Artículos</h1>
                <div class="row">
                    <table id="tabla_articulos" class="table table-striped table-bordered" style="width:100%">
                        <thead class="table-light">
                            <tr>
                                <th>ID Artículo</th>
                                <th>Código</th>
                                <th>Nombre Artículo</th>
                                <th>Categorías</th>
                                <th>Marca</th>
                                <th class="text-right">Costo</th>
                                <th class="text-right">Ganancia</th>
                                <th class="text-right">IVA</th>
                                <th class="text-right">Precio</th>
                                <th class="text-right">Stock</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Nuevo Artículo -->
    <div class="modal fade" id="modalNuevoArticulo" tabindex="-1" aria-labelledby="modalNuevoArticuloLabel" aria-hidden="true">
        <div class="modal-dialog">
            <form id="formNuevoArticulo" class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalNuevoArticuloLabel">Agregar nuevo artículo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="codigo" class="form-label">Código</label>
                        <input type="text" id="codigo" class="form-control" placeholder="Código" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombre_articulo" class="form-label">Nombre Artículo</label>
                        <input type="text" id="nombre_articulo" class="form-control text-uppercase" placeholder="Nombre" required>
                    </div>
                    <div class="mb-3">
                        <label for="categorias" class="form-label">Categorías</label>
                        <select id="categorias" class="form-select" required>
                            <option value="">Seleccione Categoría</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="marcas" class="form-label">Marca</label>
                        <select id="marcas" class="form-select" required>
                            <option value="">Seleccione Marca</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="costo" class="form-label">Costo</label>
                        <input type="number" id="costo" class="form-control text-right" placeholder="0" step="1" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="ganancia" class="form-label">Ganancia (%)</label>
                        <input type="number" id="ganancia" class="form-control text-right" placeholder="0" min="0" max="100" required>
                    </div>
                    <div class="mb-3">
                        <label for="iva" class="form-label">IVA</label>
                        <select id="iva" class="form-select" required>
                            <option value="0">Exenta</option>
                            <option value="5">5% IVA</option>
                            <option value="10">10% IVA</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="precio" class="form-label">Precio Final</label>
                        <input type="number" id="precio" class="form-control text-right" placeholder="0" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="stock" class="form-label">Stock</label>
                        <input type="number" id="stock" class="form-control text-right" placeholder="0" min="1" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="reset" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Artículo</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-3 bg-light border-top mt-auto">
        <div class="container-fluid px-4">
            <div class="d-flex align-items-center justify-content-between small text-muted">
                <div>&copy; Librería Rocio 2025</div>
            </div>
        </div>
    </footer>

    <!-- JS Dependencias -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <script src="bt/bootstrap.bundle.min.js"></script>
    <script src="alert/alertify.min.js"></script>
    <script src="js/funcionesSistema.js"></script>

    <script>
        // Variables globales
        const modalArticulo = new bootstrap.Modal(document.getElementById('modalNuevoArticulo'));
        let articulos = JSON.parse(localStorage.getItem("articulos")) || [];
        let categorias = JSON.parse(localStorage.getItem("categorias")) || [];
        let marcas = JSON.parse(localStorage.getItem("marcas")) || [];
        let tabla;
        let editandoId = null;

        // Configuración de idioma para DataTables
        const spanish = {
            "decimal": "",
            "emptyTable": "No hay datos disponibles en la tabla",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
            "infoEmpty": "Mostrando 0 a 0 de 0 registros",
            "infoFiltered": "(filtrado de _MAX_ registros totales)",
            "infoPostFix": "",
            "thousands": ",",
            "lengthMenu": "Mostrar _MENU_ registros",
            "loadingRecords": "Cargando...",
            "processing": "Procesando...",
            "search": "Buscar:",
            "zeroRecords": "No se encontraron registros coincidentes",
            "paginate": {
                "first": "Primero",
                "last": "Último",
                "next": "Siguiente",
                "previous": "Anterior"
            },
            "buttons": {
                "copy": "Copiar",
                "print": "Imprimir",
                "excel": "Excel",
                "pdf": "PDF"
            }
        };

        // Funciones
        function calcularPrecioFinal() {
            const costo = parseFloat(document.getElementById("costo").value) || 0;
            const ganancia = parseFloat(document.getElementById("ganancia").value) || 0;
            const iva = parseFloat(document.getElementById("iva").value) || 0;
            
            // Calcular precio con ganancia
            const precioConGanancia = costo * (1 + ganancia / 100);
            
            // Calcular precio con IVA
            const precioFinal = precioConGanancia * (1 + iva / 100);
            
            document.getElementById("precio").value = precioFinal.toFixed(2);
        }

        function cargarTablaArticulos() {
            if ($.fn.DataTable.isDataTable("#tabla_articulos")) {
                tabla.destroy();
            }
            
            tabla = $('#tabla_articulos').DataTable({
                data: articulos,
                columns: [
                    { data: 'idarticulo' },
                    { data: 'codigo' },
                    { data: 'nombre_articulo' },
                    { data: 'categorias' },
                    { data: 'marcas' },
                    { 
                        data: 'costo',
                        className: 'dt-body-right',
                        render: function(data) {
                            return `Gs ${parseFloat(data).toFixed(2)}`;
                        }
                    },
                    { 
                        data: 'ganancia',
                        className: 'dt-body-right',
                        render: function(data) {
                            return `${data}%`;
                        }
                    },
                    { 
                        data: 'iva',
                        className: 'dt-body-right',
                        render: function(data) {
                            return data == 0 ? 'Exenta' : `${data}%`;
                        }
                    },
                    { 
                        data: 'precio',
                        className: 'dt-body-right',
                        render: function(data) {
                            return `Gs ${parseFloat(data).toFixed(2)}`;
                        }
                    },
                    { 
                        data: 'stock',
                        className: 'dt-body-right'
                    },
                    {
                        data: null,
                        orderable: false,
                        render: function(data, type, row) {
                            return `
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-warning btn-editar" data-id="${row.idarticulo}" title="Editar">
                                        <i class="bi bi-pencil-square"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger btn-eliminar" data-id="${row.idarticulo}" title="Eliminar">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            `;
                        }
                    }
                ],
                dom: '<"top"Bf>rt<"bottom"lip><"clear">',
                buttons: [
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer"></i> Imprimir',
                        className: 'btn btn-sm btn-info'
                    },
                    {
                        extend: 'excelHtml5',
                        text: '<i class="bi bi-file-excel"></i> Excel',
                        className: 'btn btn-sm btn-success',
                        title: 'Lista_de_Articulos'
                    },
                    {
                        extend: 'pdfHtml5',
                        text: '<i class="bi bi-file-pdf"></i> PDF',
                        className: 'btn btn-sm btn-danger',
                        title: 'Lista_de_Articulos',
                        exportOptions: {
                            columns: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
                        }
                    },
                    {
                        text: '<i class="bi bi-plus-circle"></i> Nuevo',
                        className: 'btn btn-sm btn-primary',
                        action: function() {
                            prepararModalParaNuevo();
                            modalArticulo.show();
                        }
                    }
                ],
                responsive: true,
                language: spanish,
                pageLength: 10,
                order: [[0, 'asc']]
            });
        }

        function cargarOpcionesSelect() {
            const categoriaSelect = document.getElementById("categorias");
            const marcaSelect = document.getElementById("marcas");
            
            // Limpiar opciones
            categoriaSelect.innerHTML = '<option value="">Seleccione Categoría</option>';
            marcaSelect.innerHTML = '<option value="">Seleccione Marca</option>';
            
            // Cargar categorías
            categorias.forEach(cat => {
                const option = document.createElement("option");
                option.value = cat.categoria;
                option.textContent = cat.categoria;
                categoriaSelect.appendChild(option);
            });
            
            // Cargar marcas
            marcas.forEach(m => {
                const option = document.createElement("option");
                option.value = m.marcas;
                option.textContent = m.marcas;
                marcaSelect.appendChild(option);
            });
        }

        function obtenerSiguienteId() {
            return articulos.length > 0 ? Math.max(...articulos.map(a => a.idarticulo)) + 1 : 1;
        }

        function prepararModalParaNuevo() {
            editandoId = null;
            document.getElementById("modalNuevoArticuloLabel").textContent = "Agregar nuevo artículo";
            document.getElementById("formNuevoArticulo").reset();
        }

        function prepararModalParaEdicion(id) {
            const articulo = articulos.find(a => a.idarticulo === id);
            if (articulo) {
                editandoId = id;
                document.getElementById("modalNuevoArticuloLabel").textContent = "Editar artículo";
                document.getElementById("codigo").value = articulo.codigo;
                document.getElementById("nombre_articulo").value = articulo.nombre_articulo;
                document.getElementById("costo").value = articulo.costo;
                document.getElementById("ganancia").value = articulo.ganancia;
                document.getElementById("iva").value = articulo.iva;
                document.getElementById("precio").value = articulo.precio;
                document.getElementById("stock").value = articulo.stock;
                
                // Mantener selección de categoría y marca
                setTimeout(() => {
                    document.getElementById("categorias").value = articulo.categoria;
                    document.getElementById("marcas").value = articulo.marca;
                }, 0);
            }
        }

        function guardarArticulo(e) {
            e.preventDefault();
            
            const formData = {
                codigo: parseInt(document.getElementById("codigo").value.trim()),
                nombre_articulo: document.getElementById("nombre_articulo").value.trim().toUpperCase(),
                categorias: document.getElementById("categorias").value,
                marcas: document.getElementById("marcas").value,
                costo: parseFloat(document.getElementById("costo").value),
                ganancia: parseFloat(document.getElementById("ganancia").value),
                iva: parseFloat(document.getElementById("iva").value),
                precio: parseFloat(document.getElementById("precio").value),
                stock: parseInt(document.getElementById("stock").value)
            };

            // Validación de código único (excepto cuando se edita el mismo artículo)
            if (articulos.some(a => a.codigo === formData.codigo && a.idarticulo !== editandoId)) {
                alertify.error("El código ya está en uso por otro artículo");
                return;
            }

            if (editandoId) {
                // Editar artículo existente
                const index = articulos.findIndex(a => a.idarticulo === editandoId);
                articulos[index] = { idarticulo: editandoId, ...formData };
                alertify.success("Artículo actualizado correctamente");
            } else {
                // Nuevo artículo
                const nuevoArticulo = { idarticulo: obtenerSiguienteId(), ...formData };
                articulos.push(nuevoArticulo);
                alertify.success("Artículo agregado correctamente");
            }

            // Actualizar almacenamiento y tabla
            localStorage.setItem("articulos", JSON.stringify(articulos));
            cargarTablaArticulos();
            modalArticulo.hide();
        }

        function eliminarArticulo(id) {
            alertify.confirm(
                "Eliminar artículo",
                "¿Estás seguro de eliminar este artículo? Esta acción no se puede deshacer.",
                function() {
                    articulos = articulos.filter(a => a.idarticulo !== id);
                    localStorage.setItem("articulos", JSON.stringify(articulos));
                    cargarTablaArticulos();
                    alertify.success("Artículo eliminado");
                },
                function() {
                    alertify.error("Acción cancelada");
                }
            ).set('labels', {ok: 'Eliminar', cancel: 'Cancelar'});
        }

        // Eventos
        document.addEventListener("DOMContentLoaded", function() {
            // Verificar sesión
            const nombre = sessionStorage.getItem("nomUsuario");
            if (!nombre) {
                window.location.href = "error.html";
                return;
            }
            document.getElementById("usuario").textContent = nombre;

            // Cargar opciones y configuraciones
            cargarOpcionesSelect();
            cargarTablaArticulos();
            datos();

            // Eventos para calcular precio
            document.getElementById("costo").addEventListener("input", calcularPrecioFinal);
            document.getElementById("ganancia").addEventListener("input", calcularPrecioFinal);
            document.getElementById("iva").addEventListener("change", calcularPrecioFinal);

            // Evento del formulario
            document.getElementById("formNuevoArticulo").addEventListener("submit", guardarArticulo);

            // Eventos delegados para botones de acción
            document.getElementById("tabla_articulos").addEventListener("click", function(e) {
                if (e.target.closest(".btn-editar")) {
                    const id = parseInt(e.target.closest(".btn-editar").dataset.id);
                    prepararModalParaEdicion(id);
                    modalArticulo.show();
                }
                
                if (e.target.closest(".btn-eliminar")) {
                    const id = parseInt(e.target.closest(".btn-eliminar").dataset.id);
                    eliminarArticulo(id);
                }
            });
        });
    </script>
</body>
</html>