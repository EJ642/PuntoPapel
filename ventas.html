<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA_Compatible" content="IE-edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Ventas</title>
    <!-- Icono -->
    <link rel="icon" href="img/user128.png" type="image/png">
    <!-- CSS -->
    <link rel="stylesheet" href="css/estilos.css">
    <!-- ESTILOS DEL MENU -->
    <link rel="stylesheet" href="menu/styles.css">
    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">
    <link rel="stylesheet" href="bt/bootstrap.min.css">
    <!-- Bootstrap -->
    <script src="bt/bootstrap.bundle.min.js"></script>
    <!-- Iconos de Bootstrap -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">
    <!-- Alertify -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>
</head>
<body>
     <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li><a class="dropdown-item" href="clasificaciones.html">Clasificaciones</a></li>
                                <li><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="#">Créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ventas.html">Registro de ventas</a></li>
                                <li><a class="dropdown-item" href="credito_Cliente.html">Créditos con clientes</a></li>
                                <li><a class="dropdown-item" href="#">Cobró de creditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="#">Informes de Cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="#">Informes de compras</a></li>
                                <li><a class="dropdown-item" href="#">Informes de créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item" id="menuUsuarios"></li>
                            <a class="nav-link" href="usuario.html">Usuarios</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Configuraciones</a></li>
                            <li><a class="dropdown-item" href="#!">Actividad</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
  
    <!-- AQUÍ VA TODO LO QUE SE VA A VISUALIZAR EN LA PÁGINA -->
    <main>
    <div class="container-fluid px-4">
      <h1 class="mt-2">Registro de Ventas</h1>
      <div class="mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNuevaVenta">
          <i class="bi bi-plus-circle"></i> Nueva Venta
        </button>
      </div>
      <div class="row">
        <table id="tabla_ventas" class="display compact" style="width: 100%">
        <thead>
            <tr>
                <th>ID Venta</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Artículo</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Total</th>
                <th>Tipo Comprobante</th>
                <th>N° Comprobante</th>
                <th>Forma de Pago</th>
                <th>Estado</th>
                <th>Registrado por</th>
                <th>Acciones</th>
            </tr>
        </thead>

        </table>
      </div>
    </div>
  </main>

  <!-- Modal Registrar Venta -->
<div class="modal fade" id="modalNuevaVenta" tabindex="-1" aria-labelledby="modalNuevaVentaLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-lg">
        <form id="formNuevaVenta" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalNuevaVentaLabel">Registrar Venta</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 mb-2"> <label class="form-label">Cliente</label> <div class="input-group"> <select id="venta_cliente" class="form-control"> <option value="">Sin Nombre</option> </select> <button class="btn btn-outline-primary" type="button" onclick="mostrarModalCliente()"> + </button> </div> </div>
                    <div class="col-md-6 mb-2">
                        <label class="form-label">Fecha</label>
                        <input type="date" id="venta_fecha" class="form-control" required>
                    </div>
                </div>
                <div class="mb-2">
                    <label class="form-label">Detalle de Productos</label>
                    <table class="table table-bordered" id="tablaDetalleVenta">
                        <thead>
                            <tr>
                                <th>Artículo</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Total</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="detalleVentaBody"></tbody>
                    </table>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="agregarFilaVenta()">Agregar Producto</button>
                </div>
                <div class="mb-2 text-end">
                    <strong>Total Venta: Gs. <span id="totalVenta">0</span></strong>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success">Registrar Venta</button>
            </div>
        </form>
    </div>
</div>
<!-- Modal Nuevo Cliente -->
    <div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-labelledby="modalClienteLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
            <form id="formNuevoCliente" class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalClienteLabel">Agregar Nuevo Usuario</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2">
                        <label class="form-label">N° Cédula</label>
                        <input type="number" id="cedula" class="form-control" required min="1000000" max="9999999">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">RUC</label>
                        <input type="text" id="ruc" class="form-control" required min="1000000" max="9999999">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Nombre Completo</label>
                        <input type="text" id="nombre" class="form-control text-uppercase" required minlength="6" maxlength="50">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Celular</label>
                        <input type="text" id="celular" class="form-control" required minlength="6" maxlength="12">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Correo Electrónico</label>
                        <input type="email" id="correo" class="form-control" required minlength="6" maxlength="50">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Dirección</label>
                        <input type="text" id="direccion" class="form-control" required>
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Fecha Registro</label>
                        <input type="date" id="fechaRegistro" class="form-control" required minlength="5" maxlength="30">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">Estado</label>
                        <select id="estado" class="form-control" required>
                            <option value="">Seleccionar...</option>
                            <option value="activo">Activo</option>
                            <option value="inactivo">Inactivo</option>
                        </select>
                    </div>
                </div>  
                <div class="modal-footer">
                    <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                </div>
            </form>
        </div>
    </div>



     <!-- JavaScript -->
    <script src="js/funcionesSistema.js"></script>
    <script src="js/ventas.js"></script>
    <!-- MENU -->
    <script src="menu/bootstrap.bundle.min.js"></script>
    <script src="menu/scripts.js"></script>
    <!-- DATATABLES -->
    <script src="dt/jquery-3.7.1.js"></script>
    <script src="dt/datatables.min.js"></script>
    <script src="dt/jquery.dataTables.min.js"></script>
    <!-- DATATABLES Buttons extension -->
    <script src="dt/dataTables.buttons.min.js"></script>
    <script src="dt/buttons.print.min.js"></script>
    <script src="dt/buttons.html5.min.js"></script>
    <!-- DATATABLES JSZip y pdfmake para exportar -->
    <script src="dt/jszip.min.js"></script>
    <script src="dt/pdfmake.min.js"></script>
    <script src="dt/vfs_fonts.js"></script>
    <!-- DATATABLES Idioma Español -->
    <script src="dt/es-ES.js"></script>
    <script>
        // control de seguridad al cargarse la página
        document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");

            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "login.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });
        // usuario actual
        const usuarioActual = {
            rol: sessionStorage.getItem("rolUsuario")
        }
//botones para exportar a excel, pdf e imprimir
tablaVentas = $('#tabla_ventas').DataTable({
  dom: 'Bfrtip',
  buttons: [
    {
      extend: 'excelHtml5',
      text: 'Exportar a Excel',
      title: 'Ventas'
    },
    {
    extend: 'pdfHtml5',
    text: 'Exportar a PDF',
    className: 'btn btn-danger',
    orientation: 'landscape', // opcional: horizontal
    pageSize: 'A4',
    title: 'Registro de Ventas',
    customize: function (doc) {
        // Encabezado personalizado (membrete, fecha)
        const now = new Date();
        const fecha = now.toLocaleDateString();
        const hora = now.toLocaleTimeString();

        // Agregar encabezado
        doc.content.splice(0, 0,
        {
            text: [
            { text: 'LIBRERIA ROCIO\n', fontSize: 14, bold: true },
            { text: 'Registro de Ventas\n', fontSize: 12 },
            { text: `Fecha: ${fecha} - Hora: ${hora}\n\n`, fontSize: 10 }
            ],
            alignment: 'center',
            margin: [0, 0, 0, 12]
        }
        );

        // Pie de página con número de página
        doc.footer = function (currentPage, pageCount) {
        return {
            columns: [
            { text: `Fecha de exportación: ${fecha} ${hora}`, alignment: 'left', margin: [40, 0] },
            { text: `Página ${currentPage} de ${pageCount}`, alignment: 'right', margin: [0, 0, 40] }
            ],
            fontSize: 8
        };
        };

        // Ajustes opcionales de estilo
        doc.styles.tableHeader.alignment = 'center';
        doc.defaultStyle.fontSize = 10;
    }
    },
    {
      extend: 'print',
      text: 'Imprimir',
      title: 'Ventas'
    }
  ],
  language: {
    url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json"
  }
});


        
       
        //mostrar modal de cliente
        function mostrarModalCliente() {
            const modal = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));
            modal.show();
        }
        //clientes_ventas
        let tabla;
        const modalNCliente = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));
        document.addEventListener('DOMContentLoaded', function(){
            cargarTablaClientes();
            // Evento para cargar nuevos clientes
            document.getElementById('formNuevoCliente').addEventListener('submit', function(e){
                e.preventDefault();
                const nuevoCliente = {
                    idcliente: obtenerSiguienteId(clientes),
                    ruc: document.getElementById('ruc').value.trim(),
                    cedula: document.getElementById('cedula').value.trim(),
                    nombre: document.getElementById('nombre').value.trim(),
                    celular: document.getElementById('celular').value.trim(),
                    email: document.getElementById('correo').value.trim(),
                    direccion: document.getElementById('direccion').value.trim(),
                    fechaRegistro: new Date().toISOString().split('T')[0],
                    estado: document.getElementById('estado').value.trim(),
                };
                
                if(Object.values(nuevoCliente).some(val => val === '')){
                    alertify.error('Todos los campos son obligatorios');
                    return;
                }
                // Verificar cédula única
                if (clientes.some(u => u.cedula === nuevoCliente.cedula)) {
                    alertify.error('Ya existe un usuario con esta cédula');
                    return;
                }
                clientes.push(nuevoCliente);
                guardarClientes(clientes);
                this.reset();
                tabla.row.add(nuevoCliente).draw();
                modalNCliente.hide();
                alertify.success("Cliente Registrado");
            });
            //-----------------------------
            const modalECliente = new bootstrap.Modal(document.getElementById('modalEditarCliente'));
            // evento para editar cliente
            document.addEventListener('click', function(e){
                if(e.target.closest('.btn-editar')){
                    const id = parseInt(e.target.closest('.btn-editar').dataset.id);
                    const cliente = clientes.find(u => u.idcliente === id);
                    if(cliente){
                        document.getElementById('edit_idcliente').value = id; 
                        document.getElementById('edit_ruc').value = cliente.ruc
                        document.getElementById('edit_cedula').value = cliente.cedula;
                        document.getElementById('edit_nombre').value = cliente.nombre;
                        document.getElementById('edit_celular').value = cliente.celular;
                        document.getElementById('edit_correo').value = cliente.email;
                        document.getElementById('edit_direccion').value = cliente.direccion;
                        document.getElementById('edit_fechaRegistro').value = cliente.fechaRegistro;
                        document.getElementById('edit_estado').value = cliente.estado;
                        modalECliente.show();
                    }
                }
            });
            // guardar cambios al editar
            document.getElementById('formEditarCliente').addEventListener('submit', function (e){
                e.preventDefault();
                const id = parseInt(document.getElementById('edit_idcliente').value);
                const index = clientes.findIndex(u => u.idcliente === id);
                if(index !== -1){
                    clientes[index] = {
                        idcliente: id,
                        cedula: document.getElementById('edit_cedula').value.trim(),
                        ruc: document.getElementById('edit_ruc').value.trim(),
                        nombre: document.getElementById('edit_nombre').value.trim(),
                        celular: document.getElementById('edit_celular').value.trim(),
                        email: document.getElementById('edit_correo').value.trim(),
                        direccion: document.getElementById('edit_direccion').value.trim(),
                        fechaRegistro: document.getElementById('edit_fechaRegistro').value.trim(),
                        estado: document.getElementById('edit_estado').value.trim(),
                };
                guardarClientes(clientes);
                tabla.clear().rows.add(clientes).draw();
                modalECliente.hide();
                alertify.success("Cliente Actualizado");
                } 
            });
            // Evento para botón eliminar
            document.addEventListener('click', function (e) {
                    if(e.target.closest('.btn-eliminar')) {
                        const id = parseInt(e.target.closest('.btn-eliminar').dataset.id);
                        alertify.confirm("Eliminar usuario", "¿Estás seguro de eliminar este usuario?",
                            function(){
                                clientes = clientes.filter(u => u.idcliente !== id);
                                guardarClientes(clientes);
                                tabla.clear().rows.add(clientes).draw();
                                alertify.success("Cliente Eliminado");
                            },
                            function(){
                                alertify.error("Eliminación cancelada");
                            }
                        ).set('labels', {ok:'Sí', cancel:'No'});
                    }
                }); 
        });
        function cargarTablaClientes(){
            // Inicializar el DataTable
            tabla = new DataTable("#tabla_clientes", {
                data: clientes,
                columns: [
                    { data: "idcliente", title: 'Id Cliente' },
                    { data: "ruc", title: 'RUC' },
                    { data: "cedula", title: 'N° Cédula' },
                    { data: "nombre", title: 'Nombre Completo' },
                    { data: "celular", title: 'Celular' },
                    { data: "email", title: 'Correo Electrónico' },
                    { data: "direccion", title: 'Dirección' },
                    { data: "fechaRegistro", title: 'Fecha Registro' },
                    { data: "estado", title: 'Estado' },
                    {
                        data: null, 
                        title: 'Acciones',
                        render: function (data, type, row) {
                            return `
                                <button class="btn btn-sm btn-warning me-1 btn-editar" data-id="${row.idcliente}">
                                <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-danger me-1 btn-eliminar" data-id="${row.idcliente}">
                                <i class="bi bi-trash"></i>
                                </button>
                            `;
                        }
                    }
                ],
                dom: 'Bfrtip',
                buttons: [
                    {
                        extend: 'print',
                        text: '<i class="bi bi-printer"></i> Imprimir'
                    },
                    {
                        extend: 'excelHtml5',
                        text: '<i class="bi bi-filetype-xlsx"></i> Exportar a Excel'
                    },
                    {
                        extend: 'pdfHtml5',
                        text: '<i class="bi bi-filetype-pdf"></i> Exportar a PDF',
                        exportOptions: {
                                columns: [0, 1, 2, 3, 4, 5] // Excluye columna de acciones (índice 6)
                        },
                        customize: function (doc) {
                            // Verifica si `content` tiene una tabla definida
                            for (let i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table !== undefined) {
                                    const tableNode = doc.content[i];
                                    // Si hay body, ajustamos los anchos
                                    if (tableNode.table.body && tableNode.table.body.length > 0) {
                                        const colCount = tableNode.table.body[0].length;
                                        tableNode.table.widths = Array(colCount).fill('*');
                                    }
                                    break; // salimos del loop luego de encontrar la tabla
                                }
                            }
                        }
                    },
                    {
                        text: '<i class="bi bi-file-earmark-plus"></i> Nuevo Cliente',
                        className: 'btn btn-sm btn-primary',
                        action: function (e, dt, node, config) {
                            // Abrir un modal para crear un nuevo cliente
                            modalNCliente.show();
                        }
                    }
                ],
                responsive: true,
                language: spanish,
                initComplete: function () {
                    // Aplicar clases de Bootstrap a los botones
                    $('.dt-button:contains("Nuevo Cliente")')
                        .removeClass('dt-button') // elimina estilo por defecto
                        .addClass('btn btn-sm btn-primary'); // agrega estilos Bootstrap
                    $('.dt-button:contains("Imprimir")')
                        .removeClass('dt-button')
                        .addClass('btn btn-sm btn-info');
                    $('.dt-button:contains("Exportar a Excel")')
                        .removeClass('dt-button')
                        .addClass('btn btn-sm btn-success');
                    $('.dt-button:contains("Exportar a PDF")')
                        .removeClass('dt-button')
                        .addClass('btn btn-sm btn-danger');
                }
            });
            //tabla.column(5).visible(false); //Ocultar la columna contraseña
            //--------------------------------------------------------
        }
        function guardarClientes(data) {
            localStorage.setItem('clientes', JSON.stringify(data));
        }
        //--------------------------------------------------------
        function obtenerSiguienteId(clientes) {
            if (clientes.length === 0){
                return 1;
            }else{
                const maxId = Math.max(...clientes.map(u => u.idcliente || 0));
                return maxId + 1;
            }
        }
      //Ventasss
    let ventas = JSON.parse(localStorage.getItem("ventas")) || [];
    let productos = JSON.parse(localStorage.getItem("articulos")) || [];
    let clientes = JSON.parse(localStorage.getItem("clientes")) || [];

    function agregarFilaVenta() {
        const fila = document.createElement("tr");
        fila.innerHTML = `
            <td>
                <select class="form-control articulo-select" onchange="calcularFila(this)">
                    <option value="">Seleccionar...</option>
                    ${productos.map(p => `<option value="${p.idarticulo}" data-precio="${p.precio}">${p.descripcion}</option>`).join('')}
                </select>
            </td>
            <td><input type="number" class="form-control cantidad" min="1" value="1" onchange="calcularFila(this)"></td>
            <td><input type="number" class="form-control precio" readonly></td>
            <td><input type="number" class="form-control total" readonly></td>
            <td><button type="button" class="btn btn-sm btn-danger" onclick="eliminarFila(this)">X</button></td>
        `;
        document.getElementById("detalleVentaBody").appendChild(fila);
        calcularTotalVenta();
    }

    function eliminarFila(btn) {
        btn.closest("tr").remove();
        calcularTotalVenta();
    }

    function calcularFila(input) {
        const fila = input.closest("tr");
        const select = fila.querySelector(".articulo-select");
        const cantidad = parseInt(fila.querySelector(".cantidad").value) || 0;
        const precio = parseInt(select.selectedOptions[0]?.dataset.precio || 0);

        fila.querySelector(".precio").value = precio;
        fila.querySelector(".total").value = cantidad * precio;
        calcularTotalVenta();
    }

    function calcularTotalVenta() {
        let total = 0;
        document.querySelectorAll("#detalleVentaBody .total").forEach(input => {
            total += parseInt(input.value) || 0;
        });
        document.getElementById("totalVenta").textContent = total;
    }

    function guardarVentas(lista) {
        localStorage.setItem("ventas", JSON.stringify(lista));
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Cargar clientes en el select
        const selectCliente = document.getElementById("venta_cliente");
        clientes.forEach(c => {
            const option = document.createElement("option");
            option.value = c.idcliente;
            option.textContent = c.nombre;
            selectCliente.appendChild(option);
        });

        document.getElementById("formNuevaVenta").addEventListener("submit", function (e) {
            e.preventDefault();

            const idVenta = Date.now();
            const cliente = document.getElementById("venta_cliente").value;
            const fecha = document.getElementById("venta_fecha").value;
            const filas = document.querySelectorAll("#detalleVentaBody tr");

            if (!cliente || !fecha || filas.length === 0) {
                alertify.error("Todos los campos son obligatorios");
                return;
            }

            const detalle = Array.from(filas).map(fila => {
                return {
                    idarticulo: fila.querySelector(".articulo-select").value,
                    descripcion: fila.querySelector(".articulo-select").selectedOptions[0].textContent,
                    cantidad: parseInt(fila.querySelector(".cantidad").value),
                    precio: parseInt(fila.querySelector(".precio").value),
                    total: parseInt(fila.querySelector(".total").value),
                };
            });

            const nuevaVenta = {
                idventa: idVenta,
                idcliente: cliente,
                fecha: fecha,
                total: detalle.reduce((sum, d) => sum + d.total, 0),
                detalle: detalle
            };

            ventas.push(nuevaVenta);
            guardarVentas(ventas);
            document.getElementById("formNuevaVenta").reset();
            document.getElementById("detalleVentaBody").innerHTML = "";
            document.getElementById("totalVenta").textContent = "0";
            bootstrap.Modal.getInstance(document.getElementById("modalNuevaVenta")).hide();
            alertify.success("Venta registrada correctamente");
            cargarTablaVentas();
        });

        cargarTablaVentas();
    });

    function cargarTablaVentas() {
        const tablaBody = document.querySelector("#tabla_ventas tbody");
        if (!tablaBody) return;

        tablaBody.innerHTML = ventas.map(v => `
            <tr>
                <td>${v.idventa}</td>
                <td>${clientes.find(c => c.idcliente == v.idcliente)?.nombre || ''}</td>
                <td>${v.fecha}</td>
                <td>${v.total}</td>
            </tr>
        `).join("");
    }


//funcion que oculta elementos del menu dependiendo del rol
    document.addEventListener("DOMContentLoaded", function () {
    const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
    const nombre = sessionStorage.getItem("nomUsuario");

    if (!rol || !nombre) {
      alertify.error("Acceso denegado.");
      window.location.href = "login.html";
      return;
    }

    // Mostrar el nombre en el panel
    const spanUsuario = document.getElementById("usuario");
    if (spanUsuario) spanUsuario.textContent = nombre;

    
    // Ocultar menús según el rol
    switch (rol) {
      case "administrador":
        // ve todo
        break;
      case "gerente":
        ocultar(["menuUsuarios"]);
        break;
      case "cajero":
        ocultar(["menuMantenimiento", "menuCompras", "menuUsuarios"]);
        break;
      case "codificador":
        ocultar(["menuVentas", "menuCompras", "menuInformes", "menuUsuarios"]);
        break;
      default:
        alertify.error("Rol no válido.");
        window.location.href = "login.html";
    }

    // Función para ocultar elementos por ID
    function ocultar(ids) {
      ids.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.style.display = "none";
      });
    }
  });
    </script>
    

</body>
</html>