<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proveedores</title>

    <link href="menu/styles.css" rel="stylesheet" />
        
    <!-- BOOTSTRAP ICONS -->
    <link rel="stylesheet" href="bt-icons/bootstrap-icons.min.css">

    <!-- DATATABLES -->
    <link rel="stylesheet" href="dt/datatables.min.css">
    <link rel="stylesheet" href="dt/jquery.dataTables.min.css">
    <link rel="stylesheet" href="dt/buttons.dataTables.min.css">

    <!-- ALERTIFYJS -->
    <link rel="stylesheet" href="alert/alertify.min.css">
    <link rel="stylesheet" href="alert/themes/default.min.css">
    <script src="alert/alertify.min.js"></script>

    <!-- Cargar Bootstrap -->
    <link href="bt/bootstrap.min.css" rel="stylesheet">

</head>
<body>
         <div class="cabecera-nav">
        <nav class="navbar navbar-expand-lg navbar-light cabecera-nav">
            <div class="container-fluid">
                <a class="navbar-brand" href="index.html">Inicio</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavDropdown">
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown" id="menuMantenimiento">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Mantenimiento
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="articulos.html">Artículos</a></li>
                                <li><a class="dropdown-item" href="marcas.html">Marcas</a></li>
                                <li><a class="dropdown-item" href="clasificaciones.html">Clasificaciones</a></li>
                                <li><a class="dropdown-item" href="proveedores.html">Proveedores</a></li>
                                <li><a class="dropdown-item" href="cliente.html">Clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuCompras">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Compras
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Registro de compras</a></li>
                                <li><a class="dropdown-item" href="#">Créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuVentas">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Ventas
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="ventas.html">Registro de ventas</a></li>
                                <li><a class="dropdown-item" href="credito_Cliente.html">Créditos con clientes</a></li>
                                <li><a class="dropdown-item" href="#">Cobró de creditos a clientes</a></li>
                            </ul>
                        </li>
                        <li class="nav-item dropdown" id="menuInformes">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                                Informes
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#">Informes de ventas</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Créditos con clientes </a></li>
                                <li><a class="dropdown-item" href="#">Informes de Cobró de créditos</a></li>
                                <li><a class="dropdown-item" href="#">Informes de compras</a></li>
                                <li><a class="dropdown-item" href="#">Informes de créditos con Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de Pago a Proveedores</a></li>
                                <li><a class="dropdown-item" href="#">Informes de ajuste de Stock</a></li>
                            </ul>
                        </li>
                        <li class="nav-item" id="menuUsuarios"></li>
                            <a class="nav-link" href="usuario.html">Usuarios</a>
                        </li>
                    </ul>
                </div>
            </div>
            <div>
                <div class="sb-sidenav-footer">
                    <div class="small">Iniciado por:</div>
                    <div id="usuario"></div>
                </div>
            </div>
            <div>
                <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi bi-person-fill"></i></a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="#!">Configuraciones</a></li>
                            <li><a class="dropdown-item" href="#!">Actividad</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="cerrarSesion()">Cerrar sesión</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
    <!-- AQUÍ VA TODO LO QUE SE VA A VISUALIZAR EN LA PÁGINA -->
<main>
    <div class="container-fluid px-4">
        <h1 class="mt-2">Proveedores</h1>
        <div class="row">
            <table id="tabla_proveedores" class="display compact" style="width:100%">
                <thead>
                    <tr>
                        <th>Id</th>
                        <th>Proveedor</th>
                        <th>Tipo de Producto</th>
                        <th>Teléfono</th>
                        <th>Dirección</th>
                        <th>RUC</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</main>

<footer class="py-4 bg-light mt-auto">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center justify-content-between small">
            <div class="text-muted">Copyright &copy; Your Website 2025</div>
            <div>
                <a href="#">Privacy Policy</a>
                &middot;
                <a href="#">Terms &amp; Conditions</a>
            </div>
        </div>
    </div>
</footer>

<!-- Agregar Proveedor -->
<div class="modal fade" id="modalNuevoProveedor" tabindex="-1" aria-labelledby="modalProveedorLabel" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <form id="formNuevoProveedor" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalProveedorLabel">Agregar Nuevo Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div class="mb-2">
                    <label class="form-label">Proveedor</label>
                    <input type="text" id="proveedor" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Tipo de Producto</label>
                    <input type="text" id="tproducto" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Teléfono</label>
                    <input type="text" id="telefono" class="form-control" maxlength="10" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Dirección</label>
                    <input type="text" id="direccion" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">RUC</label>
                    <input type="text" id="ruc" class="form-control" maxlength="12" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="reset" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Proveedor</button>
            </div>
        </form>
    </div>
</div>

<!-- Editar Proveedor -->
<div class="modal fade" id="modalEditarProveedor" tabindex="-1" 
     aria-labelledby="modalEditarProveedorLabel" 
     aria-hidden="true" 
     data-bs-backdrop="static" 
     data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <form id="formEditarProveedor" class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditarProveedorLabel">Editar Proveedor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit_idproveedor">
                <div class="mb-2">
                    <label class="form-label">Proveedor</label>
                    <input type="text" id="edit_proveedor" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Tipo de Producto</label>
                    <input type="text" id="edit_tproducto" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Teléfono</label>
                    <input type="text" id="edit_telefono" class="form-control" maxlength="10" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">Dirección</label>
                    <input type="text" id="edit_direccion" class="form-control" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">RUC</label>
                    <input type="text" id="edit_ruc" class="form-control" maxlength="12" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
    </div>
</div>

<!-- Cargar Bootstrap JS -->
<script src="bt/bootstrap.bundle.min.js"></script>

<!-- MENU -->
<script src="menu/scripts.js"></script>
<script src="js/funcionesSistema.js"></script>
<!-- DATATABLES -->
<script src="dt/jquery-3.7.1.js"></script>
<script src="dt/datatables.min.js"></script>
<script src="dt/jquery.dataTables.min.js"></script>
<!-- DATATABLES Buttons extension -->
<script src="dt/dataTables.buttons.min.js"></script>
<script src="dt/buttons.print.min.js"></script>
<script src="dt/buttons.html5.min.js"></script>
<!-- DATATABLES JSZip y pdfmake para exportar -->
<script src="dt/jszip.min.js"></script>
<script src="dt/pdfmake.min.js"></script>
<script src="dt/vfs_fonts.js"></script>
<!-- DATATABLES Idioma Español -->
<script src="dt/es-ES.js"></script>

<script>
     // control de seguridad al cargarse la página
        document.addEventListener("DOMContentLoaded", function () {
            const nombre = sessionStorage.getItem("nomUsuario");

            if (!nombre) {
            // Si no hay sesión, redirige al login
                window.location.href = "error.html";
            } else {
            // Mostrar el nombre del usuario si existe el elemento
                const spanUsuario = document.getElementById("usuario");
                if (spanUsuario) {
                spanUsuario.textContent = nombre;
                }
            }
        });
        // usuario actual
        const usuarioActual = {
            rol: sessionStorage.getItem("rolUsuario")
        }
    // Al cargarse la página
    var proveedores = JSON.parse(localStorage.getItem("proveedores")) || [];

    let tabla;
    const modalNProveedor = new bootstrap.Modal(document.getElementById('modalNuevoProveedor'));
    const modalEProveedor = new bootstrap.Modal(document.getElementById('modalEditarProveedor'));

    document.addEventListener('DOMContentLoaded', function () {
        cargarTablaProveedores();

        // Evento para Nuevo Proveedor
        document.getElementById('formNuevoProveedor').addEventListener('submit', function (e) {
            e.preventDefault();

            const nuevoProveedor = {
                idproveedor: obtenerSiguienteId(proveedores),
                proveedor: document.getElementById('proveedor').value.trim(),
                tproducto: document.getElementById('tproducto').value.trim(),
                telefono: document.getElementById('telefono').value.trim(),
                direccion: document.getElementById('direccion').value.trim(),
                ruc: document.getElementById('ruc').value.trim(),
            };

            // Validaciones
            if (Object.values(nuevoProveedor).some(val => val === '')) {
                alert('Todos los campos son obligatorios');
                return;
            }

            if (nuevoProveedor.telefono.length < 10) {
                alert('El teléfono debe tener al menos 10 caracteres');
                return;
            }

            if (nuevoProveedor.ruc.length < 7 || nuevoProveedor.ruc.length > 12) {
                alert('El RUC debe tener entre 7 y 12 caracteres');
                return;
            }

            proveedores.push(nuevoProveedor);
            guardarProveedores(proveedores);
            this.reset();
            tabla.row.add(nuevoProveedor).draw();
            modalNProveedor.hide();
            alertify.success("Registro guardado");
        });

        // Evento para botón editar
        document.addEventListener('click', function (e) {
            if (e.target.closest('.btn-editar')) {
                const id = parseInt(e.target.closest('.btn-editar').dataset.id);
                const proveedor = proveedores.find(u => u.idproveedor === id);

                if (!proveedor) {
                    alertify.error('Proveedor no encontrado');
                    return;
                }

                // Cargar los datos del proveedor en el formulario de edición
                document.getElementById('edit_idproveedor').value = proveedor.idproveedor;
                document.getElementById('edit_proveedor').value = proveedor.proveedor;4
                document.getElementById('edit_tproducto').value = proveedor.tproducto;
                document.getElementById('edit_telefono').value = proveedor.telefono;
                document.getElementById('edit_direccion').value = proveedor.direccion;
                document.getElementById('edit_ruc').value = proveedor.ruc;

                // Mostrar el modal de edición
                modalEProveedor.show();
            }
        });

        // Guardar cambios al editar
        document.getElementById('formEditarProveedor').addEventListener('submit', function (e) {
            e.preventDefault();

            const id = parseInt(document.getElementById('edit_idproveedor').value);
            const nuevoValor = {
                tproducto: document.getElementById('edit_tproducto').value.trim(),
                proveedor: document.getElementById('edit_proveedor').value.trim(),
                telefono: document.getElementById('edit_telefono').value.trim(),
                direccion: document.getElementById('edit_direccion').value.trim(),
                ruc: document.getElementById('edit_ruc').value.trim(),
            };

            // Validaciones
            if (Object.values(nuevoValor).some(val => val === '')) {
                alertify.error('Todos los campos son obligatorios');
                return;
            }


            if (nuevoValor.telefono.length < 10) {
                alertify.error('El teléfono debe tener al menos 10 caracteres');
                return;
            }

            if (nuevoValor.ruc.length < 7 || nuevoValor.ruc.length > 12) {
                alertify.error('El RUC debe tener entre 7 y 12 caracteres');
                return;
            }

            const index = proveedores.findIndex(u => u.idproveedor === id);
            if (index === -1) {
                alertify.error('Error al actualizar el proveedor');
                return;
            }

            proveedores[index] = { idproveedor: id, ...nuevoValor };
            guardarProveedores(proveedores);
            tabla.clear().rows.add(proveedores).draw();
            modalEProveedor.hide();
            alertify.success("Proveedor actualizado");
        });

        // Evento para botón eliminar
        document.addEventListener('click', function (e) {
            if (e.target.closest('.btn-eliminar')) {
                const id = parseInt(e.target.closest('.btn-eliminar').dataset.id);
                alertify.confirm("Eliminar proveedor", "¿Estás seguro de eliminar este proveedor?",
                    function() {
                        proveedores = proveedores.filter(u => u.idproveedor !== id);
                        guardarProveedores(proveedores);
                        tabla.clear().rows.add(proveedores).draw();
                        alertify.success("Proveedor eliminado");
                    },
                    function() {
                        alertify.error("Eliminación cancelada");
                    }
                ).set('labels', {ok: 'Sí', cancel: 'No'});
            }
        });
    });

    // Cargar la tabla de proveedores
    function cargarTablaProveedores() {
        tabla = new DataTable("#tabla_proveedores", {
            data: proveedores,
            columns: [
                { data: 'idproveedor', title: 'Id Proveedor' },
                { data: 'proveedor', title: 'Proveedor' },
                { data: 'tproducto', title: 'Tipo de Producto' },
                { data: 'telefono', title: 'Teléfono' },
                { data: 'direccion', title: 'Dirección' },
                { data: 'ruc', title: 'RUC' },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `
                            <button class="btn btn-sm btn-warning me-1 btn-editar" data-id="${row.idproveedor}">
                                <i class="bi bi-pencil-square"></i>
                            </button>
                            <button class="btn btn-sm btn-danger btn-eliminar" data-id="${row.idproveedor}">
                                <i class="bi bi-trash"></i>
                            </button>
                        `;
                    }
                }
            ],
            dom: 'Bfrtip',
            buttons: [
                {
                    extend: 'print',
                    text: '<i class="bi bi-printer"></i> Imprimir',
                    className: 'btn btn-outline-primary' // Botón con color primario
                },
                {
                    extend: 'excelHtml5',
                    text: '<i class="bi bi-filetype-xlsx"></i> Exportar a Excel',
                    className: 'btn btn-outline-success' // Botón con color de éxito
                },
                {
                    extend: 'pdfHtml5',
                    text: '<i class="bi bi-filetype-pdf"></i> Exportar a PDF',
                    exportOptions: {
                        columns: [0, 1, 2, 3, 4, 5]
                    },
                    customize: function (doc) {
                            const now = new Date();
                            const fecha = now.toLocaleDateString();
                            const hora = now.toLocaleTimeString();
                            // Agregar encabezado personalizado
                            doc.content.splice(0, 0, {
                                text: [
                                { text: 'LIBRERIA ROCIO\n', fontSize: 14, bold: true },
                                { text: 'Reporte de registros de usuarios\n', fontSize: 12 },
                                ],
                                alignment: 'center',
                                margin: [0, 0, 0, 12]
                            });

                             // Ajustar ancho automático
                            for (let i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table !== undefined) {
                                const tableNode = doc.content[i];
                                if (tableNode.table.body && tableNode.table.body.length > 0) {
                                    const colCount = tableNode.table.body[0].length;
                                    tableNode.table.widths = Array(colCount).fill('*');
                                }
                                break;
                                }
                            }

                            // Pie de página con número de página
                            doc.footer = function (currentPage, pageCount) {
                                return {
                                columns: [
                                    { text: `Fecha de exportación: ${fecha} ${hora}`, alignment: 'left', margin: [40, 0] },
                                    { text: `Página ${currentPage} de ${pageCount}`, alignment: 'right', margin: [0, 0, 40] }
                                ],
                                fontSize: 8
                                };
                            };

                            doc.defaultStyle.fontSize = 10;


                            // Verifica si `content` tiene una tabla definida
                            for (let i = 0; i < doc.content.length; i++) {
                                if (doc.content[i].table !== undefined) {
                                    const tableNode = doc.content[i];
                                    // Si hay body, ajustamos los anchos
                                    if (tableNode.table.body && tableNode.table.body.length > 0) {
                                        const colCount = tableNode.table.body[0].length;
                                        tableNode.table.widths = Array(colCount).fill('*');
                                    }
                                    break; // salimos del loop luego de encontrar la tabla
                                }
                            }
                        }
                    
                },
                {
                    text: '<i class="bi bi-file-earmark-plus"></i> Nuevo proveedor',
                    className: 'btn btn-outline-info', // Botón con color de información
                    action: function (e, dt, node, config) {
                        modalNProveedor.show();
                    }
                }
            ],
            responsive: true,
            language: spanish
        });
    }

    function guardarProveedores(data) {
        localStorage.setItem('proveedores', JSON.stringify(data));
    }

    function obtenerSiguienteId(proveedores) {
        if (proveedores.length === 0) {
            return 1;
        } else {
            const maxId = Math.max(...proveedores.map(u => u.idproveedor || 0));
            return maxId + 1;
        }
    }
    //funcion que oculta elementos del menu dependiendo del rol
    document.addEventListener("DOMContentLoaded", function () {
    const rol = sessionStorage.getItem("rolUsuario"); // debe tener: administrador, gerente, etc.
    const nombre = sessionStorage.getItem("nomUsuario");

    if (!rol || !nombre) {
      alertify.error("Acceso denegado.");
      window.location.href = "login.html";
      return;
    }

    // Mostrar el nombre en el panel
    const spanUsuario = document.getElementById("usuario");
    if (spanUsuario) spanUsuario.textContent = nombre;

    
    // Ocultar menús según el rol
    switch (rol) {
      case "administrador":
        // ve todo
        break;
      case "gerente":
        ocultar(["menuUsuarios"]);
        break;
      case "cajero":
        ocultar(["menuMantenimiento", "menuCompras", "menuUsuarios"]);
        break;
      case "codificador":
        ocultar(["menuVentas", "menuCompras", "menuInformes", "menuUsuarios"]);
        break;
      default:
        alertify.error("Rol no válido.");
        window.location.href = "login.html";
    }

    // Función para ocultar elementos por ID
    function ocultar(ids) {
      ids.forEach(id => {
        const elem = document.getElementById(id);
        if (elem) elem.style.display = "none";
      });
    }
  });
</script>
</body>
</html>
